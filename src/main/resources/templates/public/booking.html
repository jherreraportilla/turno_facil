<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <th:block th:replace="~{fragments/head :: favicons}" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="${config.businessName + ' - Reserva tu turno'}">TurnoFacil</title>

    <!-- SEO Meta Tags -->
    <meta name="description" th:content="${config.businessName + ' - Reserva tu cita online de forma rapida y sencilla'}">
    <meta name="robots" content="index, follow">
    <meta property="og:type" content="website">
    <meta property="og:title" th:content="${config.businessName + ' - Reserva tu turno'}">
    <meta property="og:description" th:content="${config.businessName + ' - Reserva tu cita online de forma rapida y sencilla'}">
    <meta property="og:image" th:if="${config.logoUrl}" th:content="${config.logoUrl}">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Toast UI Calendar (via jsDelivr) -->
    <link href="https://cdn.jsdelivr.net/npm/@toast-ui/calendar@2.1.3/dist/toastui-calendar.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/@toast-ui/calendar@2.1.3/dist/toastui-calendar.min.js"></script>

    <!-- TurnoFacil Theme -->
    <link rel="stylesheet" th:href="@{/css/turnofacil-theme.css}">
    <link rel="stylesheet" th:href="@{/css/public-pages.css}">
</head>
<body class="public-page">

<!-- MENSAJE DE EXITO -->
<th:block th:if="${param.reserved}">
    <div class="success-banner">
        <i class="bi bi-check-circle-fill me-3"></i>
        Turno reservado con exito. Actualizando calendario...
    </div>
    <script>
        setTimeout(() => {
            window.location.href = window.location.pathname;
        }, 2500);
    </script>
</th:block>

<!-- MENSAJE DE ERROR -->
<th:block th:if="${error}">
    <div class="error-banner">
        <i class="bi bi-exclamation-triangle-fill me-3"></i>
        <span th:text="${error}">Error</span>
    </div>
</th:block>

<div class="booking-wrapper">
    <div class="booking-card">

        <!-- HEADER -->
        <div class="booking-header">
            <a th:href="@{'/public/' + ${config.slug}}" class="booking-back-link">
                <i class="bi bi-arrow-left me-1"></i> Volver al sitio
            </a>
            <div class="logo-placeholder">
                <span th:text="${#strings.substring(config.businessName, 0, 2).toUpperCase()}">NE</span>
            </div>
            <h1 th:text="${config.businessName}">Mi Negocio</h1>
            <p>Reserva tu cita en 3 simples pasos</p>
        </div>

        <!-- INDICADOR DE PROGRESO -->
        <div class="booking-progress">
            <div class="progress-step active" data-step="1">
                <span class="step-number">1</span>
                <span class="step-label">Servicio</span>
            </div>
            <div class="progress-line"></div>
            <div class="progress-step" data-step="2">
                <span class="step-number">2</span>
                <span class="step-label">Fecha y hora</span>
            </div>
            <div class="progress-line"></div>
            <div class="progress-step" data-step="3">
                <span class="step-number">3</span>
                <span class="step-label">Confirmar</span>
            </div>
        </div>

        <!-- PASO 1: SERVICIOS -->
        <div id="step1" class="step active">
            <div class="services-section">
                <div class="container">
                    <h3>Que servicio necesitas?</h3>

                    <!-- Servicios dinamicos -->
                    <div th:if="${services != null and !services.isEmpty()}" class="services-grid">
                        <div th:each="service, iter : ${services}"
                             class="service-card-enhanced"
                             th:classappend="${iter.index == 0} ? 'active' : ''"
                             th:data-duration="${service.durationMinutes}"
                             th:data-service-id="${service.id}"
                             th:data-price="${service.price}"
                             th:data-name="${service.name}">
                            <div class="service-icon" th:style="'background-color: ' + ${service.color}">
                                <i th:class="${service.icon}"></i>
                            </div>
                            <div class="service-info">
                                <h4 th:text="${service.name}">Servicio</h4>
                                <p class="service-description" th:if="${service.description}" th:text="${service.description}">Descripcion del servicio</p>
                                <div class="service-meta">
                                    <span class="duration">
                                        <i class="bi bi-clock me-1"></i>
                                        <span th:text="${service.durationMinutes}">30</span> min
                                    </span>
                                    <span th:if="${service.price}" class="price">
                                        <span th:text="${#numbers.formatDecimal(service.price, 1, 2)}">25</span> EUR
                                    </span>
                                </div>
                            </div>
                            <div class="service-check">
                                <i class="bi bi-check-circle-fill"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Servicios por defecto si no hay configurados -->
                    <div th:if="${services == null or services.isEmpty()}" class="row g-4 justify-content-center">
                        <div class="col-md-4">
                            <div class="service-card active" data-duration="30">
                                <div class="icon"><i class="bi bi-scissors"></i></div>
                                <h5>Consulta rapida</h5>
                                <p class="duration">30 minutos</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="service-card" data-duration="60">
                                <div class="icon"><i class="bi bi-person-badge"></i></div>
                                <h5>Consulta estandar</h5>
                                <p class="duration">60 minutos</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CALENDARIO -->
        <div class="calendar-section">
            <h3>Selecciona fecha y hora</h3>

            <!-- Leyenda de bloqueos -->
            <div class="blocked-legend" th:if="${not #lists.isEmpty(blockedSlots)}">
                <span class="legend-title"><i class="bi bi-info-circle me-1"></i>Leyenda:</span>
                <div class="legend-items">
                    <span class="legend-item">
                        <span class="legend-color" style="background: #C45C4A;"></span>
                        Ocupado
                    </span>
                    <span class="legend-item">
                        <span class="legend-color" style="background: #10B981;"></span>
                        Vacaciones
                    </span>
                    <span class="legend-item">
                        <span class="legend-color" style="background: #F59E0B;"></span>
                        Descanso
                    </span>
                    <span class="legend-item">
                        <span class="legend-color" style="background: #3B82F6;"></span>
                        Reunion
                    </span>
                    <span class="legend-item">
                        <span class="legend-color" style="background: #EF4444;"></span>
                        Festivo
                    </span>
                    <span class="legend-item">
                        <span class="legend-color" style="background: #6B7280;"></span>
                        Otro
                    </span>
                </div>
            </div>

            <div id="calendar"></div>
        </div>

        <!-- PASO 2: FORMULARIO -->
        <div id="step2" class="step">
            <div class="booking-form-section">
                <!-- Timer de lock -->
                <div id="lockTimer" class="lock-timer-container">
                    <i class="bi bi-hourglass-split lock-timer-icon"></i>
                    <div class="lock-timer-text">
                        Completa tu reserva en <span class="timer" id="timerDisplay">3:00</span>
                    </div>
                </div>

                <!-- Resumen de la reserva -->
                <div class="booking-summary">
                    <h3><i class="bi bi-clipboard-check me-2"></i>Resumen de tu reserva</h3>
                    <div class="summary-card">
                        <div class="summary-item">
                            <i class="bi bi-tag"></i>
                            <div>
                                <span class="label">Servicio</span>
                                <span class="value" id="summaryService">-</span>
                            </div>
                        </div>
                        <div class="summary-item">
                            <i class="bi bi-calendar3"></i>
                            <div>
                                <span class="label">Fecha</span>
                                <span class="value" id="summaryDate">-</span>
                            </div>
                        </div>
                        <div class="summary-item">
                            <i class="bi bi-clock"></i>
                            <div>
                                <span class="label">Hora</span>
                                <span class="value" id="summaryTime">-</span>
                            </div>
                        </div>
                        <div class="summary-item" id="summaryPriceRow" style="display: none;">
                            <i class="bi bi-currency-euro"></i>
                            <div>
                                <span class="label">Precio</span>
                                <span class="value" id="summaryPrice">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <h2>Completa tus datos</h2>
                <form th:action="@{'/public/book/' + ${config.slug}}" method="post" class="booking-form">
                    <input type="hidden" name="date" id="finalDate">
                    <input type="hidden" name="time" id="finalTime">
                    <input type="hidden" name="duration" id="finalDuration">
                    <input type="hidden" name="serviceId" id="finalServiceId">

                    <div class="mb-4">
                        <label class="form-label">Nombre completo *</label>
                        <input type="text" name="clientName" class="form-control" placeholder="Tu nombre" required>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Telefono (WhatsApp) *</label>
                        <input type="tel" name="clientPhone" class="form-control" placeholder="+34 600 123 456" required>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Email (opcional)</label>
                        <input type="email" name="clientEmail" class="form-control" placeholder="tu@email.com">
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Notas (opcional)</label>
                        <textarea name="notes" class="form-control" rows="3" placeholder="Ej: Quiero el mismo estilo de la ultima vez"></textarea>
                    </div>

                    <div class="d-flex gap-3 justify-content-center flex-wrap">
                        <button type="button" class="btn btn-back" onclick="backToCalendar()">
                            <i class="bi bi-arrow-left me-2"></i>Atras
                        </button>
                        <button type="submit" class="btn btn-submit">
                            <i class="bi bi-check-circle me-2"></i>Confirmar reserva
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="booking-footer">
            <p>Powered by <a href="#">TurnoFacil</a></p>
        </div>

    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');
        let selectedDuration = 30;
        let selectedServiceId = null;

        // Variables para el resumen
        let selectedServiceName = '';
        let selectedPrice = 0;
        let selectedDate = '';
        let selectedTime = '';

        // Obtener duracion del primer servicio activo
        const firstActiveService = document.querySelector('.service-card-enhanced.active, .service-card.active');
        if (firstActiveService) {
            selectedDuration = parseInt(firstActiveService.dataset.duration) || 30;
            selectedServiceId = firstActiveService.dataset.serviceId || null;
            selectedServiceName = firstActiveService.dataset.name || firstActiveService.querySelector('h4, h5')?.textContent || 'Servicio';
            selectedPrice = parseFloat(firstActiveService.dataset.price) || 0;
        }

        // SELECCION DE SERVICIO (nuevo estilo)
        document.querySelectorAll('.service-card-enhanced, .service-card').forEach(card => {
            card.addEventListener('click', function () {
                document.querySelectorAll('.service-card-enhanced, .service-card').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                selectedDuration = parseInt(this.dataset.duration) || 30;
                selectedServiceId = this.dataset.serviceId || null;
                selectedServiceName = this.dataset.name || this.querySelector('h4, h5')?.textContent || 'Servicio';
                selectedPrice = parseFloat(this.dataset.price) || 0;
            });
        });

        // TURNOS OCUPADOS (se cargan inicialmente y se refrescan dinámicamente)
        let occupiedEvents = [[${occupiedAppointments}]];
        const slugForApi = /*[[ ${config.slug} ]]*/ '';

        // BLOQUEOS DE HORARIO
        const blockedSlots = [[${blockedSlots}]];

        // DIAS DE TRABAJO
        const workingDaysStr = /*[[ ${config.workingDays} ]]*/ '1,2,3,4,5';
        const workingDays = workingDaysStr.split(',').map(s => parseInt(s.trim()));

        // Configuracion horaria
        const openingTime = /*[[ ${config.openingTime} ]]*/ '09:00';
        const closingTime = /*[[ ${config.closingTime} ]]*/ '20:00';

        // Convertir turnos ocupados a eventos de Toast UI Calendar
        const occupiedCalendarEvents = occupiedEvents.map((a, idx) => ({
            id: 'occupied-' + idx,
            calendarId: 'occupied',
            title: 'OCUPADO',
            start: a.start,
            end: a.end,
            isReadOnly: true,
            category: 'time',
            backgroundColor: '#C45C4A',
            borderColor: '#A94A3A',
            color: '#ffffff'
        }));

        // Convertir bloqueos a eventos de Toast UI Calendar
        const blockedCalendarEvents = blockedSlots.flatMap((b, idx) => {
            const events = [];
            const startDate = new Date(b.startDate);
            const endDate = new Date(b.endDate);

            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const bgColor = b.color || '#6B7280';

                if (b.allDay) {
                    // Para bloqueos de día completo, crear evento que cubra todo el horario laboral
                    events.push({
                        id: 'blocked-' + idx + '-' + dateStr,
                        calendarId: 'blocked',
                        title: b.title,
                        start: dateStr + 'T' + openingTime + ':00',
                        end: dateStr + 'T' + closingTime + ':00',
                        isAllDay: false,
                        isReadOnly: true,
                        category: 'time',
                        backgroundColor: bgColor,
                        borderColor: bgColor,
                        color: '#ffffff'
                    });
                } else if (b.startTime && b.endTime) {
                    events.push({
                        id: 'blocked-' + idx + '-' + dateStr,
                        calendarId: 'blocked',
                        title: b.title,
                        start: dateStr + 'T' + b.startTime + ':00',
                        end: dateStr + 'T' + b.endTime + ':00',
                        isReadOnly: true,
                        category: 'time',
                        backgroundColor: bgColor,
                        borderColor: bgColor,
                        color: '#ffffff'
                    });
                }
            }
            return events;
        });

        // Combinar todos los eventos
        const allEvents = [...occupiedCalendarEvents, ...blockedCalendarEvents];

        // Crear el calendario Toast UI
        const Calendar = tui.Calendar;
        const calendar = new Calendar(calendarEl, {
            defaultView: 'week',
            usageStatistics: false,
            isReadOnly: false,
            useDetailPopup: false,
            useFormPopup: false,
            week: {
                startDayOfWeek: 1,
                dayNames: ['Dom', 'Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab'],
                hourStart: parseInt(openingTime.split(':')[0]),
                hourEnd: parseInt(closingTime.split(':')[0]),
                taskView: false,
                eventView: ['allday', 'time'],
                showNowIndicator: true,
                showTimezoneCollapseButton: false,
                timezonesCollapsed: true
            },
            month: {
                startDayOfWeek: 1,
                dayNames: ['Dom', 'Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab'],
                narrowWeekend: false,
                visibleWeeksCount: 0
            },
            calendars: [
                {
                    id: 'occupied',
                    name: 'Ocupados',
                    backgroundColor: '#C45C4A',
                    borderColor: '#A94A3A',
                    color: '#ffffff'
                },
                {
                    id: 'blocked',
                    name: 'Bloqueados',
                    backgroundColor: '#6B7280',
                    borderColor: '#6B7280',
                    color: '#ffffff'
                }
            ],
            theme: {
                common: {
                    backgroundColor: '#ffffff',
                    border: '1px solid #e5e7eb',
                    dayName: { color: '#374151' },
                    holiday: { color: '#C45C4A' },
                    saturday: { color: '#6366f1' },
                    today: { color: '#D4AF74' },
                    gridSelection: {
                        backgroundColor: 'rgba(212, 175, 116, 0.3)',
                        border: '2px solid #D4AF74'
                    }
                },
                week: {
                    dayName: {
                        borderLeft: '1px solid #e5e7eb',
                        borderTop: '1px solid #e5e7eb',
                        borderBottom: '2px solid #D4AF74',
                        backgroundColor: '#f9fafb'
                    },
                    dayGrid: {
                        borderRight: '1px solid #e5e7eb'
                    },
                    dayGridLeft: {
                        borderRight: '1px solid #e5e7eb',
                        backgroundColor: '#f9fafb',
                        width: '60px'
                    },
                    timeGrid: {
                        borderRight: '1px solid #e5e7eb'
                    },
                    timeGridLeft: {
                        borderRight: '1px solid #e5e7eb',
                        backgroundColor: '#f9fafb',
                        width: '60px'
                    },
                    timeGridLeftAdditionalTimezone: {
                        backgroundColor: '#f9fafb'
                    },
                    timeGridHalfHourLine: {
                        borderBottom: '1px dotted #e5e7eb'
                    },
                    timeGridHourLine: {
                        borderBottom: '1px solid #d1d5db'
                    },
                    nowIndicatorLabel: {
                        color: '#D4AF74'
                    },
                    nowIndicatorPast: {
                        border: '1px dashed #D4AF74'
                    },
                    nowIndicatorBullet: {
                        backgroundColor: '#D4AF74'
                    },
                    nowIndicatorToday: {
                        border: '2px solid #D4AF74'
                    },
                    pastTime: {
                        color: '#9ca3af'
                    },
                    futureTime: {
                        color: '#374151'
                    },
                    gridSelection: {
                        color: '#D4AF74'
                    }
                },
                month: {
                    dayName: {
                        borderLeft: '1px solid #e5e7eb',
                        backgroundColor: '#f9fafb'
                    },
                    holidayExceptThisMonth: { color: 'rgba(196, 92, 74, 0.4)' },
                    dayExceptThisMonth: { color: '#d1d5db' },
                    moreView: {
                        backgroundColor: '#ffffff',
                        border: '1px solid #e5e7eb'
                    },
                    moreViewTitle: {
                        backgroundColor: '#f9fafb'
                    }
                }
            },
            template: {
                time: function(event) {
                    return '<span style="color: ' + (event.color || '#fff') + ';">' + event.title + '</span>';
                },
                allday: function(event) {
                    return '<span style="color: ' + (event.color || '#fff') + ';">' + event.title + '</span>';
                },
                timegridDisplayPrimaryTime: function(props) {
                    const hour = props.time.getHours();
                    const minutes = props.time.getMinutes();
                    return (hour < 10 ? '0' : '') + hour + ':' + (minutes < 10 ? '0' : '') + minutes;
                },
                timegridNowIndicatorLabel: function(props) {
                    const hour = props.time.getHours();
                    const minutes = props.time.getMinutes();
                    return (hour < 10 ? '0' : '') + hour + ':' + (minutes < 10 ? '0' : '') + minutes;
                }
            }
        });

        // Cargar eventos iniciales
        calendar.createEvents(allEvents);

        // Crear controles de navegacion personalizados
        createCalendarControls(calendar);

        // Evento click en celda del calendario
        calendar.on('selectDateTime', function(info) {
            const clickStart = new Date(info.start);
            const clickEnd = new Date(clickStart.getTime() + selectedDuration * 60000);

            // Verificar si esta en el pasado
            if (clickStart < new Date()) {
                showBookingAlert('No puedes reservar en fechas pasadas.');
                calendar.clearGridSelections();
                return;
            }

            // Verificar si esta ocupado o bloqueado
            const isBlocked = isTimeSlotBlocked(clickStart, clickEnd, occupiedEvents, blockedSlots);

            if (isBlocked) {
                showBookingAlert('Este horario no esta disponible. Por favor, elige otro.');
                calendar.clearGridSelections();
                return;
            }

            // Verificar dia de trabajo
            const dayOfWeek = clickStart.getDay() === 0 ? 7 : clickStart.getDay();
            if (!workingDays.includes(dayOfWeek)) {
                showBookingAlert('Este dia no esta disponible para citas.');
                calendar.clearGridSelections();
                return;
            }

            const date = clickStart.toISOString().split('T')[0];
            const time = clickStart.toTimeString().substring(0, 5);

            selectedDate = date;
            selectedTime = time;

            document.getElementById('finalDate').value = date;
            document.getElementById('finalTime').value = time;
            document.getElementById('finalDuration').value = selectedDuration;
            document.getElementById('finalServiceId').value = selectedServiceId || '';

            // Actualizar resumen
            updateBookingSummary();

            // Actualizar indicador de progreso
            updateProgress(3);

            document.getElementById('step1').classList.remove('active');
            document.getElementById('step2').classList.add('active');

            // Iniciar timer de lock
            startLockTimer();

            document.getElementById('step2').scrollIntoView({ behavior: 'smooth' });
            calendar.clearGridSelections();
        });

        // Detener timer cuando se envia el formulario
        const bookingForm = document.querySelector('.booking-form');
        if (bookingForm) {
            bookingForm.addEventListener('submit', function() {
                stopLockTimer();
            });
        }

        // Auto-refresh del calendario cada 30 segundos
        setInterval(function() {
            fetch('/public/book/' + slugForApi + '/occupied-slots')
                .then(r => r.json())
                .then(data => {
                    occupiedEvents = data;
                    // Limpiar eventos ocupados y volver a crear
                    calendar.clear();
                    const newOccupied = data.map((a, idx) => ({
                        id: 'occupied-' + idx,
                        calendarId: 'occupied',
                        title: 'OCUPADO',
                        start: a.start,
                        end: a.end,
                        isReadOnly: true,
                        category: 'time',
                        backgroundColor: '#C45C4A',
                        borderColor: '#A94A3A',
                        color: '#ffffff'
                    }));
                    calendar.createEvents([...newOccupied, ...blockedCalendarEvents]);
                })
                .catch(() => {});
        }, 30000);

        // Funcion para verificar si un slot esta bloqueado
        function isTimeSlotBlocked(start, end, occupied, blocked) {
            // Verificar turnos ocupados
            for (const event of occupied) {
                const eventStart = new Date(event.start);
                const eventEnd = event.end ? new Date(event.end) : new Date(eventStart.getTime() + (event.duration || 30) * 60000);
                if (start < eventEnd && end > eventStart) {
                    return true;
                }
            }

            // Verificar bloqueos
            const dateStr = start.toISOString().split('T')[0];
            const timeStr = start.toTimeString().substring(0, 5);

            for (const block of blocked) {
                const blockStart = block.startDate;
                const blockEnd = block.endDate;

                if (dateStr >= blockStart && dateStr <= blockEnd) {
                    if (block.allDay) {
                        return true;
                    } else if (block.startTime && block.endTime) {
                        if (timeStr >= block.startTime && timeStr < block.endTime) {
                            return true;
                        }
                    }
                }
            }

            return false;
        }

        // Crear controles de navegacion
        function createCalendarControls(cal) {
            const controlsHtml = `
                <div class="tui-calendar-controls">
                    <div class="tui-nav-buttons">
                        <button type="button" class="btn-cal-nav" id="calPrev">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <button type="button" class="btn-cal-today" id="calToday">Hoy</button>
                        <button type="button" class="btn-cal-nav" id="calNext">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                    <h3 class="tui-calendar-title" id="calTitle"></h3>
                    <div class="tui-view-buttons">
                        <button type="button" class="btn-cal-view active" data-view="week">Semana</button>
                        <button type="button" class="btn-cal-view" data-view="month">Mes</button>
                        <button type="button" class="btn-cal-view" data-view="day">Dia</button>
                    </div>
                </div>
            `;
            calendarEl.insertAdjacentHTML('beforebegin', controlsHtml);

            // Actualizar titulo
            updateCalendarTitle(cal);

            // Event listeners
            document.getElementById('calPrev').addEventListener('click', () => {
                cal.prev();
                updateCalendarTitle(cal);
            });
            document.getElementById('calNext').addEventListener('click', () => {
                cal.next();
                updateCalendarTitle(cal);
            });
            document.getElementById('calToday').addEventListener('click', () => {
                cal.today();
                updateCalendarTitle(cal);
            });

            document.querySelectorAll('.btn-cal-view').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.btn-cal-view').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    cal.changeView(this.dataset.view);
                    updateCalendarTitle(cal);
                });
            });
        }

        function updateCalendarTitle(cal) {
            const date = cal.getDate().toDate();
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                           'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            document.getElementById('calTitle').textContent = months[date.getMonth()] + ' ' + date.getFullYear();
        }
    });

    // ====== TIMER DE LOCK ======
    let lockTimerInterval = null;
    let lockTimeRemaining = 180; // 3 minutos en segundos

    function startLockTimer() {
        lockTimeRemaining = 180;
        updateTimerDisplay();

        if (lockTimerInterval) {
            clearInterval(lockTimerInterval);
        }

        lockTimerInterval = setInterval(function() {
            lockTimeRemaining--;
            updateTimerDisplay();

            const timerContainer = document.getElementById('lockTimer');

            // Advertencia cuando queda menos de 1 minuto
            if (lockTimeRemaining <= 60 && lockTimeRemaining > 0) {
                timerContainer.classList.add('warning');
                timerContainer.classList.remove('expired');
            }

            // Expirado
            if (lockTimeRemaining <= 0) {
                clearInterval(lockTimerInterval);
                timerContainer.classList.add('expired');
                timerContainer.classList.remove('warning');
                showBookingAlert('El tiempo ha expirado. Por favor, selecciona un horario nuevamente.');
                setTimeout(function() {
                    backToCalendar();
                }, 2000);
            }
        }, 1000);
    }

    function stopLockTimer() {
        if (lockTimerInterval) {
            clearInterval(lockTimerInterval);
            lockTimerInterval = null;
        }
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(lockTimeRemaining / 60);
        const seconds = lockTimeRemaining % 60;
        const display = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
        document.getElementById('timerDisplay').textContent = display;
    }

    function backToCalendar() {
        stopLockTimer();
        document.getElementById('step2').classList.remove('active');
        document.getElementById('step1').classList.add('active');
        updateProgress(2);

        // Resetear timer visual
        const timerContainer = document.getElementById('lockTimer');
        timerContainer.classList.remove('warning', 'expired');
        document.getElementById('timerDisplay').textContent = '3:00';

        document.querySelector('.calendar-section').scrollIntoView({ behavior: 'smooth' });
    }

    function updateProgress(step) {
        document.querySelectorAll('.progress-step').forEach((el, index) => {
            el.classList.remove('active', 'completed');
            if (index + 1 < step) {
                el.classList.add('completed');
            } else if (index + 1 === step) {
                el.classList.add('active');
            }
        });
    }

    function updateBookingSummary() {
        // Obtener servicio seleccionado
        const activeService = document.querySelector('.service-card-enhanced.active, .service-card.active');
        if (activeService) {
            const serviceName = activeService.dataset.name || activeService.querySelector('h4, h5')?.textContent || 'Servicio';
            document.getElementById('summaryService').textContent = serviceName;

            const price = parseFloat(activeService.dataset.price) || 0;
            if (price > 0) {
                document.getElementById('summaryPrice').textContent = price.toFixed(2) + ' EUR';
                document.getElementById('summaryPriceRow').style.display = 'flex';
            } else {
                document.getElementById('summaryPriceRow').style.display = 'none';
            }
        }

        // Fecha
        const dateInput = document.getElementById('finalDate').value;
        if (dateInput) {
            document.getElementById('summaryDate').textContent = formatDateSpanish(dateInput);
        }

        // Hora
        const timeInput = document.getElementById('finalTime').value;
        if (timeInput) {
            document.getElementById('summaryTime').textContent = timeInput + 'h';
        }
    }

    function formatDateSpanish(dateStr) {
        const days = ['Domingo', 'Lunes', 'Martes', 'Miercoles', 'Jueves', 'Viernes', 'Sabado'];
        const months = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio',
                        'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
        const date = new Date(dateStr + 'T12:00:00');
        return `${days[date.getDay()]}, ${date.getDate()} de ${months[date.getMonth()]}`;
    }

    function showBookingAlert(message) {
        // Crear alerta temporal
        const alertDiv = document.createElement('div');
        alertDiv.className = 'booking-alert';
        alertDiv.innerHTML = `<i class="bi bi-exclamation-circle me-2"></i>${message}`;
        document.body.appendChild(alertDiv);

        setTimeout(() => {
            alertDiv.classList.add('fade-out');
            setTimeout(() => alertDiv.remove(), 300);
        }, 3000);
    }
    /*]]>*/
</script>

<style>
    .error-banner {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
        color: white;
        text-align: center;
        padding: 20px;
        font-size: 18px;
        z-index: 9999;
        animation: slideDown 0.5s ease-out;
    }

    /* Toast UI Calendar Controls - Tema Claro */
    .tui-calendar-controls {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        background: #f9fafb;
        border-radius: 12px 12px 0 0;
        border-bottom: 2px solid #D4AF74;
        flex-wrap: wrap;
        gap: 12px;
    }

    .tui-nav-buttons {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-cal-nav {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        color: #374151;
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .btn-cal-nav:hover {
        background: #D4AF74;
        border-color: #D4AF74;
        color: #ffffff;
    }

    .btn-cal-today {
        background: linear-gradient(135deg, #D4AF74 0%, #C9A227 100%);
        border: none;
        color: #ffffff;
        padding: 10px 20px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(212, 175, 116, 0.3);
    }

    .btn-cal-today:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(212, 175, 116, 0.4);
    }

    .tui-calendar-title {
        color: #374151;
        font-size: 1.35rem;
        font-weight: 700;
        margin: 0;
        flex: 1;
        text-align: center;
    }

    .tui-view-buttons {
        display: flex;
        gap: 4px;
        background: #e5e7eb;
        padding: 4px;
        border-radius: 10px;
    }

    .btn-cal-view {
        background: transparent;
        border: none;
        color: #6b7280;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .btn-cal-view:hover {
        color: #374151;
        background: rgba(255,255,255,0.5);
    }

    .btn-cal-view.active {
        background: #ffffff;
        color: #D4AF74;
        font-weight: 600;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* Toast UI Calendar Container Styles */
    #calendar {
        height: 600px !important;
        min-height: 600px;
        border-radius: 0 0 12px 12px;
        overflow: hidden;
        background: #ffffff;
    }

    /* Toast UI Calendar overrides - Tema Claro */
    .toastui-calendar-layout {
        background: #ffffff !important;
    }

    .toastui-calendar-day-names {
        background: #f9fafb !important;
    }

    .toastui-calendar-day-name {
        color: #374151 !important;
        font-weight: 600 !important;
    }

    .toastui-calendar-grid-selection {
        background: rgba(212, 175, 116, 0.3) !important;
        border: 2px solid #D4AF74 !important;
    }

    .toastui-calendar-weekday-grid {
        background: #ffffff !important;
    }

    .toastui-calendar-time {
        color: #6b7280 !important;
    }

    .toastui-calendar-today .toastui-calendar-weekday-grid-date {
        background: #D4AF74 !important;
        color: #1a1a2e !important;
    }

    .toastui-calendar-panel-resizer {
        display: none !important;
    }

    @media (max-width: 768px) {
        .tui-calendar-controls {
            flex-direction: column;
            align-items: stretch;
        }

        .tui-nav-buttons,
        .tui-view-buttons {
            justify-content: center;
        }

        .tui-calendar-title {
            order: -1;
            text-align: center;
        }
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
