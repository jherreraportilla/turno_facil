<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <th:block th:replace="fragments/head :: favicons" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="${config.businessName + ' ‚Äì Reserva tu turno'}">TurnoF√°cil</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 2rem 0; margin: 0; }
        .booking-wrapper { max-width: 1200px; margin: 0 auto; }
        .card-main { border-radius: 32px; overflow: hidden; box-shadow: 0 40px 80px rgba(0,0,0,0.5); background: white; }
        .header { background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 5rem 3rem; text-align: center; }
        .header h1 { font-weight: 900; font-size: 4.2rem; margin: 0; text-shadow: 0 6px 20px rgba(0,0,0,0.4); }
        .header p { font-size: 1.5rem; opacity: 0.95; margin-top: 1.5rem; }
        .logo-img { width: 140px; height: 140px; object-fit: cover; border-radius: 50%; border: 8px solid white; margin-bottom: 1.5rem; box-shadow: 0 15px 40px rgba(0,0,0,0.4); }
        .services { background: #f8f9ff; padding: 3rem 2rem; }
        .service-card {
          transition: all 0.4s;
          border: 3px solid transparent;
          border-radius: 24px;
          cursor: pointer;
          background: white;
          box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .service-card:hover { transform: translateY(-12px); box-shadow: 0 25px 50px rgba(102,126,234,0.3); }
        .service-card.active {
          border-color: #667eea !important;
          background: #eef5ff !important;
          box-shadow: 0 25px 50px rgba(102,126,234,0.4) !important;
        }
        .service-card h5 { font-weight: 800; }

        .calendar-container { background: white; padding: 3rem 2rem; }
        .fc-button-primary { background: #667eea !important; border: none !important; border-radius: 20px !important; padding: 0.9rem 2rem !important; font-weight: bold !important; }

        /* Estilos mejorados para slots ocupados */
        .fc-timegrid-event.occupied-slot {
          background: linear-gradient(135deg, #ff4757 0%, #e84118 100%) !important;
          border: none !important;
          opacity: 1 !important;
          cursor: not-allowed !important;
        }
        .fc-timegrid-event.occupied-slot .fc-event-main {
          padding: 8px !important;
          color: white !important;
          font-weight: bold !important;
          text-align: center !important;
          font-size: 0.85rem !important;
        }
        .fc-timegrid-event.occupied-slot:hover {
          opacity: 0.9 !important;
          transform: none !important;
        }

        /* Quitar l√≠mite de altura de los eventos */
        .fc-v-event, .fc-timegrid-event {
          max-height: none !important;
          overflow: visible !important;
        }
        .fc-event-title {
          overflow: visible !important;
        }

        .step { display: none; }
        .step.active { display: block; }

        /* MENSAJE DE √âXITO + RECARGA AUTOM√ÅTICA */
        .success-banner {
          position: fixed;
          top: 0; left: 0; right: 0;
          background: linear-gradient(90deg, #28a745, #20c997);
          color: white;
          padding: 1.8rem;
          text-align: center;
          font-size: 1.6rem;
          font-weight: bold;
          z-index: 9999;
          box-shadow: 0 10px 40px rgba(0,0,0,0.5);
          animation: slideDown .6s ease-out;
        }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

<!-- MENSAJE DE √âXITO + RECARGA AUTOM√ÅTICA (ACTIVADO CON ?reserved=true) -->
<th:block th:if="${param.reserved}">
    <div class="success-banner">
        <i class="bi bi-check-circle-fill fs-1 me-3"></i>
        ¬°Turno reservado con √©xito! Actualizando calendario...
    </div>

    <script>
        setTimeout(() => {
          // Recarga limpia (sin par√°metros) para que se vean los nuevos turnos
          window.location.href = window.location.pathname;
        }, 2500);
    </script>
</th:block>

<div class="booking-wrapper">
    <div class="card-main">

        <!-- HEADER -->
        <div class="header">
            <img src="https://via.placeholder.com/140/667eea/ffffff?text=BE" alt="Logo" class="logo-img">
            <h1 th:text="${config.businessName}">Belen</h1>
            <p>Selecciona el servicio y el horario que prefieras</p>
        </div>

        <!-- PASO 1: SERVICIOS -->
        <div id="step1" class="step active">
            <div class="services">
                <div class="container">
                    <h3 class="text-center mb-5 fw-bold text-primary">¬øQu√© servicio necesitas?</h3>
                    <div class="row g-4 justify-content-center">
                        <div class="col-md-4">
                            <div class="service-card p-5 text-center active" data-duration="30">
                                <i class="bi bi-scissors display-4 text-primary mb-3"></i>
                                <h5>Corte de cabello</h5>
                                <p class="text-muted mb-2">30 minutos</p>
                                <strong class="fs-4 text-primary">25‚Ç¨</strong>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="service-card p-5 text-center" data-duration="60">
                                <i class="bi bi-person-badge display-4 text-primary mb-3"></i>
                                <h5>Corte + Barba</h5>
                                <p class="text-muted mb-2">60 minutos</p>
                                <strong class="fs-4 text-primary">40‚Ç¨</strong>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="service-card p-5 text-center" data-duration="90">
                                <i class="bi bi-stars display-4 text-primary mb-3"></i>
                                <h5>Tratamiento completo</h5>
                                <p class="text-muted mb-2">90 minutos</p>
                                <strong class="fs-4 text-primary">70‚Ç¨</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CALENDARIO ‚Äì SIEMPRE VISIBLE -->
        <div class="calendar-container">
            <div id="calendar"></div>
        </div>

        <!-- PASO 2: FORMULARIO -->
        <div id="step2" class="step">
            <div class="container py-5">
                <h2 class="text-center mb-5 fw-bold">Confirma tu reserva</h2>
                <form th:action="@{'/public/book/' + ${config.slug}}" method="post" class="row g-4 justify-content-center">
                    <input type="hidden" name="date" id="finalDate">
                    <input type="hidden" name="time" id="finalTime">
                    <input type="hidden" name="duration" id="finalDuration">

                    <div class="col-lg-7">
                        <label class="form-label fw-bold fs-5">Nombre completo *</label>
                        <input type="text" name="clientName" class="form-control form-control-lg rounded-3" required>
                    </div>
                    <div class="col-lg-7">
                        <label class="form-label fw-bold fs-5">Tel√©fono (WhatsApp) *</label>
                        <input type="tel" name="clientPhone" class="form-control form-control-lg rounded-3" required>
                    </div>
                    <div class="col-lg-7">
                        <label class="form-label fs-5">Email (opcional)</label>
                        <input type="email" name="clientEmail" class="form-control rounded-3">
                    </div>
                    <div class="col-lg-7">
                        <label class="form-label fs-5">Notas</label>
                        <textarea name="notes" class="form-control rounded-3" rows="4" placeholder="Ej: Quiero el mismo estilo de la √∫ltima vez"></textarea>
                    </div>
                    <div class="col-lg-7 text-center mt-4">
                        <button type="button" class="btn btn-outline-secondary rounded-pill px-5 py-3 me-3" onclick="backToCalendar()">Atr√°s</button>
                        <button type="submit" class="btn btn-success btn-lg rounded-pill px-7 py-4 fw-bold">Confirmar reserva</button>
                    </div>
                </form>
            </div>
        </div>

    </div>
</div>

<!-- SCRIPT 100% FUNCIONANDO -->
<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');
        let selectedDuration = 30;

        // SELECCI√ìN DE SERVICIO
        document.querySelectorAll('.service-card').forEach(card => {
            card.addEventListener('click', function () {
                document.querySelectorAll('.service-card').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                selectedDuration = parseInt(this.dataset.duration);
            });
        });

        // TURNOS OCUPADOS
        const occupiedEvents = [[${occupiedAppointments}]];

        // DEBUG: Ver qu√© turnos est√°n ocupados
        console.log('Turnos ocupados cargados:', occupiedEvents);
        console.log('Total de turnos:', occupiedEvents.length);

        // D√çAS DE TRABAJO
        const workingDaysStr = /*[[ ${config.workingDays} ]] */ '1,2,3,4,5';
        const workingDays = workingDaysStr.split(',').map(s => parseInt(s.trim()));

        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
            buttonText: { today: 'Hoy', month: 'Mes', week: 'Semana', day: 'D√≠a' },
            locale: 'es',
            validRange: { start: new Date() },
            businessHours: {
                daysOfWeek: workingDays,
                startTime: /*[[ ${config.openingTime} ]] */ '09:00',
                endTime: /*[[ ${config.closingTime} ]] */ '20:00'
            },
            slotDuration: '00:' + selectedDuration + ':00',
            slotMinTime: /*[[ ${config.openingTime} ]] */ '09:00',
            slotMaxTime: /*[[ ${config.closingTime} ]] */ '20:00',
            height: 850,
            nowIndicator: true,
            events: occupiedEvents.map(a => ({
                title: 'üö´ NO DISPONIBLE',
                start: a.start,
                allDay: false,
                backgroundColor: '#ff4757',
                borderColor: '#e84118',
                textColor: '#ffffff',
                classNames: ['occupied-slot'],
                editable: false,
                display: 'block'
            })),

            dateClick: function (info) {
                if (info.dayEl.classList.contains('fc-day-disabled')) return;

                const clickedTime = info.dateStr;

                // Verificar si el horario est√° ocupado
                const isOccupied = occupiedEvents.some(e => {
                    const eventStart = new Date(e.start);
                    const clickStart = new Date(clickedTime);
                    return eventStart.getTime() === clickStart.getTime();
                });

                if (isOccupied) {
                    alert('‚ö†Ô∏è Este horario ya est√° ocupado. Por favor, elige otro.');
                    return;
                }

                const date = info.dateStr.split('T')[0];
                const time = info.dateStr.split('T')[1]?.substring(0, 5) || info.date.toTimeString().substring(0, 5);

                document.getElementById('finalDate').value = date;
                document.getElementById('finalTime').value = time;
                document.getElementById('finalDuration').value = selectedDuration;

                document.getElementById('step1').classList.remove('active');
                document.getElementById('step2').classList.add('active');
            }
        });
        calendar.render();
    });

    function backToCalendar() {
        document.getElementById('step2').classList.remove('active');
        document.getElementById('step1').classList.add('active');
    }
    /*]]>*/
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>