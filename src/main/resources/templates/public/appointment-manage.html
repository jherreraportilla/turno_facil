<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mi Turno – TurnoFácil</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/turnofacil-theme.css}">
    <link rel="stylesheet" th:href="@{/css/public-pages.css}">
    <meta name="_csrf" th:content="${_csrf?.token}">
    <meta name="_csrf_header" th:content="${_csrf?.headerName}">
</head>
<body class="public-page">

<div class="booking-wrapper" style="max-width: 600px;">
    <div class="booking-card">
        <!-- Header -->
        <div class="booking-header" style="padding: 2.5rem 2rem;">
            <h1 style="font-size: 1.8rem; margin: 0;">
                <i class="bi bi-calendar-check me-2"></i>Mi Turno
            </h1>
            <p th:if="${appointment}" class="mb-0 mt-2 opacity-75"
               th:text="${appointment.businessName ?: 'TurnoFacil'}">Negocio</p>
        </div>

        <div style="padding: 2rem;">
            <!-- Mensajes -->
            <div th:if="${success}" class="alert alert-success d-flex align-items-center" role="alert">
                <i class="bi bi-check-circle-fill me-2"></i>
                <span th:text="${success}">Turno cancelado</span>
            </div>

            <div th:if="${error}" class="alert alert-danger d-flex align-items-center" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <span th:text="${error}">Error</span>
            </div>

            <!-- Sin turno encontrado -->
            <div th:if="${appointment == null && error == null}" class="text-center py-5">
                <i class="bi bi-search display-1" style="color: var(--tf-text-tertiary);"></i>
                <p class="mt-3 fs-5 text-muted">No se encontró el turno solicitado.</p>
            </div>

            <!-- Detalles del turno -->
            <div th:if="${appointment != null}">
                <div style="background: var(--tf-bg-primary); border-radius: var(--tf-radius-lg); padding: 1.5rem; border: 1px solid var(--tf-border-light);">
                    <div class="row g-3">
                        <div class="col-sm-6">
                            <small class="text-muted text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.5px;">Fecha</small>
                            <div class="fw-bold" style="color: var(--tf-text-primary);" th:text="${appointment.date}">2025-01-15</div>
                        </div>
                        <div class="col-sm-6">
                            <small class="text-muted text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.5px;">Hora</small>
                            <div class="fw-bold" style="color: var(--tf-text-primary);" th:text="${appointment.time}">10:00</div>
                        </div>
                        <div class="col-sm-6" th:if="${appointment.serviceName}">
                            <small class="text-muted text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.5px;">Servicio</small>
                            <div class="fw-bold" style="color: var(--tf-text-primary);" th:text="${appointment.serviceName}">Corte</div>
                        </div>
                        <div class="col-sm-6">
                            <small class="text-muted text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.5px;">Duración</small>
                            <div class="fw-bold" style="color: var(--tf-text-primary);">
                                <span th:text="${appointment.duration}">30</span> minutos
                            </div>
                        </div>
                        <div class="col-12">
                            <small class="text-muted text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.5px;">Estado</small>
                            <div>
                                <span class="badge"
                                      th:classappend="${appointment.status.badgeClass + ' ' + appointment.status.textClass}"
                                      th:text="${appointment.status.getDisplayName('es')}">Pendiente</span>
                            </div>
                        </div>
                        <div class="col-12" th:if="${appointment.notes != null && !appointment.notes.isBlank()}">
                            <small class="text-muted text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.5px;">Notas</small>
                            <div style="color: var(--tf-text-secondary);" th:text="${appointment.notes}">Sin notas</div>
                        </div>
                    </div>
                </div>

                <!-- Acciones para turnos activos -->
                <div th:if="${appointment.status.name() != 'CANCELLED' && appointment.status.name() != 'COMPLETED'}" class="mt-4">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-primary btn-lg" onclick="showReschedule()">
                            <i class="bi bi-arrow-repeat me-2"></i>Reagendar mi turno
                        </button>
                        <button type="button" class="btn btn-danger btn-lg" onclick="confirmCancel()">
                            <i class="bi bi-x-circle me-2"></i>Cancelar mi turno
                        </button>
                    </div>
                    <small class="text-muted d-block text-center mt-2">La cancelación no se puede deshacer</small>
                </div>

                <!-- Panel de reagendar (oculto por defecto) -->
                <div id="reschedulePanel" class="mt-4" style="display: none;">
                    <div style="background: var(--tf-bg-primary); border-radius: var(--tf-radius-lg); padding: 1.5rem; border: 2px solid var(--tf-brand);">
                        <h5 class="mb-3" style="color: var(--tf-brand);">
                            <i class="bi bi-arrow-repeat me-2"></i>Elegir nueva fecha y hora
                        </h5>

                        <div id="rescheduleLoading" class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2 text-muted">Cargando horarios disponibles...</p>
                        </div>

                        <div id="rescheduleForm" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Fecha</label>
                                <input type="date" class="form-control form-control-lg" id="rescheduleDate"
                                       onchange="loadTimeSlots()">
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Hora disponible</label>
                                <div id="timeSlotsContainer">
                                    <p class="text-muted">Selecciona una fecha primero</p>
                                </div>
                            </div>

                            <form th:action="@{|/public/appointment/${token}/reschedule|}" method="post" id="rescheduleSubmitForm">
                                <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}">
                                <input type="hidden" name="date" id="rescheduleSubmitDate">
                                <input type="hidden" name="time" id="rescheduleSubmitTime">
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary btn-lg" id="rescheduleSubmitBtn" disabled>
                                        <i class="bi bi-check-circle me-2"></i>Confirmar nuevo horario
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="hideReschedule()">
                                        Cancelar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Turno ya cancelado -->
                <div th:if="${appointment.status.name() == 'CANCELLED'}" class="text-center mt-4">
                    <i class="bi bi-x-circle display-4 text-danger"></i>
                    <p class="mt-2 text-muted">Este turno ya fue cancelado.</p>
                </div>

                <!-- Turno completado -->
                <div th:if="${appointment.status.name() == 'COMPLETED'}" class="text-center mt-4">
                    <i class="bi bi-check-circle display-4 text-success"></i>
                    <p class="mt-2 text-muted">Este turno ya fue completado.</p>
                </div>

                <!-- Form oculto para cancelar -->
                <form th:action="@{|/public/appointment/${token}/cancel|}" method="post" id="cancelForm" style="display: none;">
                    <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}">
                </form>
            </div>
        </div>
    </div>

    <div class="text-center mt-3">
        <small style="color: var(--tf-text-tertiary);">Powered by <strong style="color: var(--tf-brand);">TurnoFacil</strong></small>
    </div>
</div>

<!-- Modal de confirmación cancelar -->
<div class="modal fade" id="cancelModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content" style="border-radius: var(--tf-radius-xl);">
            <div class="modal-body text-center py-4">
                <i class="bi bi-exclamation-triangle display-4 text-warning mb-3"></i>
                <h5>¿Cancelar tu turno?</h5>
                <p class="text-muted mb-4">Esta acción no se puede deshacer.</p>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-danger" onclick="document.getElementById('cancelForm').submit()">
                        <i class="bi bi-x-circle me-2"></i>Sí, cancelar
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Volver</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    const token = /*[[${token}]]*/ '';
    const appointmentDuration = /*[[${appointment?.duration ?: 30}]]*/ 30;

    let availableData = null;

    function confirmCancel() {
        new bootstrap.Modal(document.getElementById('cancelModal')).show();
    }

    function showReschedule() {
        document.getElementById('reschedulePanel').style.display = 'block';
        document.getElementById('rescheduleLoading').style.display = 'block';
        document.getElementById('rescheduleForm').style.display = 'none';

        fetch('/public/appointment/' + token + '/available-slots')
            .then(r => r.json())
            .then(data => {
                availableData = data;
                document.getElementById('rescheduleLoading').style.display = 'none';
                document.getElementById('rescheduleForm').style.display = 'block';

                // Set min date to tomorrow
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const dateInput = document.getElementById('rescheduleDate');
                dateInput.min = tomorrow.toISOString().split('T')[0];
            })
            .catch(() => {
                document.getElementById('rescheduleLoading').innerHTML =
                    '<p class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>Error al cargar horarios</p>';
            });
    }

    function hideReschedule() {
        document.getElementById('reschedulePanel').style.display = 'none';
        document.getElementById('rescheduleSubmitBtn').disabled = true;
        document.getElementById('rescheduleSubmitDate').value = '';
        document.getElementById('rescheduleSubmitTime').value = '';
    }

    function loadTimeSlots() {
        if (!availableData) return;
        const dateStr = document.getElementById('rescheduleDate').value;
        if (!dateStr) return;

        const selectedDate = new Date(dateStr + 'T00:00:00');
        const dayOfWeek = selectedDate.getDay() === 0 ? 7 : selectedDate.getDay(); // 1=Mon...7=Sun

        // Check working day
        const workingDays = availableData.workingDays.split(',').map(d => parseInt(d.trim()));
        if (!workingDays.includes(dayOfWeek)) {
            document.getElementById('timeSlotsContainer').innerHTML =
                '<p class="text-warning"><i class="bi bi-exclamation-circle me-1"></i>Este dia no es laborable</p>';
            return;
        }

        // Generate time slots
        const opening = availableData.openingTime.split(':');
        const closing = availableData.closingTime.split(':');
        const openMin = parseInt(opening[0]) * 60 + parseInt(opening[1]);
        const closeMin = parseInt(closing[0]) * 60 + parseInt(closing[1]);
        const slotDuration = appointmentDuration || availableData.slotDuration;

        // Get occupied times for this date
        const occupiedOnDate = availableData.occupiedSlots
            .filter(s => s.date === dateStr)
            .map(s => ({ time: s.time, duration: s.duration }));

        // Check blocked slots for this date
        const isBlockedTime = (timeStr) => {
            return availableData.blockedSlots.some(b => {
                if (dateStr < b.startDate || dateStr > b.endDate) return false;
                if (b.allDay) return true;
                if (b.startTime && b.endTime) {
                    return timeStr >= b.startTime && timeStr < b.endTime;
                }
                return false;
            });
        };

        let html = '<div class="d-flex flex-wrap gap-2">';
        let hasSlots = false;

        for (let m = openMin; m + slotDuration <= closeMin; m += slotDuration) {
            const h = String(Math.floor(m / 60)).padStart(2, '0');
            const min = String(m % 60).padStart(2, '0');
            const timeStr = h + ':' + min;

            // Check if occupied (overlap check)
            const slotStart = m;
            const slotEnd = m + slotDuration;
            const isOccupied = occupiedOnDate.some(o => {
                const oParts = o.time.split(':');
                const oStart = parseInt(oParts[0]) * 60 + parseInt(oParts[1]);
                const oEnd = oStart + o.duration;
                return slotStart < oEnd && slotEnd > oStart;
            });

            if (isOccupied || isBlockedTime(timeStr)) continue;

            hasSlots = true;
            html += '<button type="button" class="btn btn-outline-primary time-slot-btn" ' +
                    'onclick="selectTimeSlot(this, \'' + timeStr + '\')">' + timeStr + '</button>';
        }

        html += '</div>';

        if (!hasSlots) {
            html = '<p class="text-warning"><i class="bi bi-exclamation-circle me-1"></i>No hay horarios disponibles este dia</p>';
        }

        document.getElementById('timeSlotsContainer').innerHTML = html;
        document.getElementById('rescheduleSubmitBtn').disabled = true;
        document.getElementById('rescheduleSubmitTime').value = '';
    }

    function selectTimeSlot(btn, time) {
        document.querySelectorAll('.time-slot-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        document.getElementById('rescheduleSubmitDate').value = document.getElementById('rescheduleDate').value;
        document.getElementById('rescheduleSubmitTime').value = time;
        document.getElementById('rescheduleSubmitBtn').disabled = false;
    }
</script>
</body>
</html>
