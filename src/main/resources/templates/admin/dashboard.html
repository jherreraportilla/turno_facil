<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <th:block th:replace="~{fragments/head :: favicons}" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard – TurnoFácil</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Toast UI Calendar (via jsDelivr) -->
    <link href="https://cdn.jsdelivr.net/npm/@toast-ui/calendar@2.1.3/dist/toastui-calendar.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/@toast-ui/calendar@2.1.3/dist/toastui-calendar.min.js"></script>

    <!-- Chart.js para gráficos de tendencias -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- CSRF Token para peticiones AJAX -->
    <meta name="_csrf" th:content="${_csrf?.token}">
    <meta name="_csrf_header" th:content="${_csrf?.headerName}">

    <!-- TurnoFácil Theme -->
    <link rel="stylesheet" th:href="@{/css/turnofacil-theme.css}">
    <link rel="stylesheet" th:href="@{/css/admin-pages.css}">
</head>
<body class="admin-page">

<!-- NAVBAR -->
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container py-4">
    <!-- Bienvenida -->
    <h2 class="mb-4" style="color: var(--tf-text-primary);">
        Bienvenido, <strong th:text="${businessConfig.businessName}">Negocio</strong>
    </h2>

    <!-- ENLACE PÚBLICO -->
    <div class="public-link-card mb-5">
        <div class="icon">
            <i class="bi bi-link-45deg"></i>
        </div>
        <h3>Página pública de reservas</h3>
        <p>Comparte este enlace con tus clientes para que reserven online</p>

        <div class="input-group mb-3" style="max-width: 600px; margin: 0 auto;">
            <input type="text" class="form-control public-link-input"
                   th:value="${publicBookingUrl}"
                   id="publicLink" readonly>
            <button class="btn btn-admin-primary" onclick="copyLink()">
                <i class="bi bi-clipboard me-2"></i>Copiar
            </button>
        </div>

        <a th:href="@{|/public/book/${businessConfig.slug}|}"
           target="_blank"
           class="btn btn-admin-secondary">
            <i class="bi bi-box-arrow-up-right me-2"></i>Ver página pública
        </a>
    </div>

    <!-- KPIs -->
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="kpi-card">
                <div class="card-body text-center p-4">
                    <div class="kpi-icon primary mx-auto mb-3">
                        <i class="bi bi-calendar-day fs-2"></i>
                    </div>
                    <div class="kpi-value" th:text="${kpiTurnosHoy}">0</div>
                    <div class="kpi-label">Turnos Hoy</div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="kpi-card">
                <div class="card-body text-center p-4">
                    <div class="kpi-icon info mx-auto mb-3">
                        <i class="bi bi-calendar-week fs-2"></i>
                    </div>
                    <div class="kpi-value" th:text="${kpiTurnosSemana}">0</div>
                    <div class="kpi-label">Esta Semana</div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="kpi-card">
                <div class="card-body text-center p-4">
                    <div class="kpi-icon success mx-auto mb-3">
                        <i class="bi bi-check-circle fs-2"></i>
                    </div>
                    <div class="kpi-value" th:text="${kpiCompletados}">0</div>
                    <div class="kpi-label">Completados</div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="kpi-card">
                <div class="card-body text-center p-4">
                    <div class="kpi-icon danger mx-auto mb-3">
                        <i class="bi bi-exclamation-triangle fs-2"></i>
                    </div>
                    <div class="kpi-value">
                        <span th:text="${kpiTasaNoShow}">0</span>%
                    </div>
                    <div class="kpi-label">Tasa No-Show</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tendencia de citas (últimas 4 semanas) -->
    <div class="admin-card mb-5">
        <div class="card-body p-4">
            <h5 class="fw-bold mb-3" style="color: var(--tf-text-primary);">
                <i class="bi bi-graph-up-arrow me-2" style="color: var(--tf-brand);"></i>
                Citas - Últimas 4 semanas
            </h5>
            <div style="height: 220px;">
                <canvas id="trendsChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Resumen del Mes -->
    <div class="admin-card mb-5">
        <div class="card-body p-4">
            <h5 class="fw-bold mb-4" style="color: var(--tf-text-primary);">
                <i class="bi bi-graph-up me-2" style="color: var(--tf-brand);"></i>
                Resumen del Mes
            </h5>

            <div class="row g-4 mb-4">
                <div class="col-md-3 text-center">
                    <div class="mb-2">
                        <i class="bi bi-calendar-check fs-3" style="color: var(--tf-brand);"></i>
                    </div>
                    <h4 class="fw-bold mb-1" style="color: var(--tf-brand);" th:text="${kpiTurnosMes}">0</h4>
                    <small class="text-muted">Total del Mes</small>
                </div>

                <div class="col-md-3 text-center">
                    <div class="mb-2">
                        <i class="bi bi-hourglass-split fs-3" style="color: var(--tf-warning);"></i>
                    </div>
                    <h4 class="fw-bold mb-1" style="color: var(--tf-warning);" th:text="${kpiPendientes}">0</h4>
                    <small class="text-muted">Pendientes</small>
                </div>

                <div class="col-md-3 text-center">
                    <div class="mb-2">
                        <i class="bi bi-x-circle fs-3" style="color: var(--tf-danger);"></i>
                    </div>
                    <h4 class="fw-bold mb-1" style="color: var(--tf-danger);" th:text="${kpiCancelados}">0</h4>
                    <small class="text-muted">Cancelados</small>
                </div>

                <div class="col-md-3 text-center">
                    <div class="mb-2">
                        <i class="bi bi-person-x fs-3" style="color: var(--tf-text-secondary);"></i>
                    </div>
                    <h4 class="fw-bold mb-1" style="color: var(--tf-text-secondary);" th:text="${kpiNoShow}">0</h4>
                    <small class="text-muted">No se presentaron</small>
                </div>
            </div>

            <!-- Barra de progreso -->
            <div>
                <div class="d-flex justify-content-between mb-2">
                    <small class="text-muted">Estado de los turnos</small>
                    <small class="text-muted">
                        <span th:text="${kpiCompletados}">0</span> de
                        <span th:text="${kpiTurnosMes}">0</span> completados
                    </small>
                </div>
                <div class="admin-progress">
                    <div class="progress-bar success" role="progressbar"
                         th:style="'width: ' + ${kpiTurnosMes > 0 ? (kpiCompletados * 100.0 / kpiTurnosMes) : 0} + '%'">
                        <span th:if="${kpiTurnosMes > 0}"
                              th:text="${#numbers.formatDecimal(kpiCompletados * 100.0 / kpiTurnosMes, 1, 1)} + '%'">0%</span>
                    </div>
                    <div class="progress-bar warning" role="progressbar"
                         th:style="'width: ' + ${kpiTurnosMes > 0 ? (kpiPendientes * 100.0 / kpiTurnosMes) : 0} + '%'">
                    </div>
                    <div class="progress-bar danger" role="progressbar"
                         th:style="'width: ' + ${kpiTurnosMes > 0 ? (kpiCancelados * 100.0 / kpiTurnosMes) : 0} + '%'">
                    </div>
                </div>
                <div class="d-flex gap-3 mt-2">
                    <small><span class="status-badge confirmed">Completados</span></small>
                    <small><span class="status-badge pending">Pendientes</span></small>
                    <small><span class="status-badge cancelled">Cancelados</span></small>
                </div>
            </div>
        </div>
    </div>

    <!-- TURNOS DE HOY -->
    <div class="admin-card mb-5">
        <div class="admin-card-header">
            <h4>
                <i class="bi bi-calendar-day me-2"></i>
                Turnos de hoy – <span th:text="${today}">2025-12-12</span>
            </h4>
        </div>
        <div class="admin-card-body">
            <div th:if="${todayAppointments.isEmpty()}" class="text-center py-5">
                <i class="bi bi-calendar-check display-1" style="color: var(--tf-text-tertiary);"></i>
                <p class="mt-3 fs-5 text-muted">No tienes turnos hoy. ¡Día tranquilo!</p>
            </div>

            <div class="table-responsive" th:unless="${todayAppointments.isEmpty()}">
                <table class="admin-table">
                    <thead>
                    <tr>
                        <th>Hora</th>
                        <th>Cliente</th>
                        <th>Teléfono</th>
                        <th>Notas</th>
                        <th>Reservado el</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="a : ${todayAppointments}"
                        th:attr="data-id=${a.id},
                                 data-date=${a.date},
                                 data-time=${a.time},
                                 data-client=${a.clientName},
                                 data-phone=${a.clientPhone},
                                 data-email=${a.clientEmail ?: ''},
                                 data-notes=${a.notes ?: ''},
                                 data-internal-notes=${a.internalNotes ?: ''},
                                 data-service-id=${a.service?.id ?: ''},
                                 data-status=${a.status != null ? a.status.name() : 'PENDING'}">
                        <td><strong th:text="${a.time}">10:00</strong></td>
                        <td th:text="${a.clientName}">Juan Pérez</td>
                        <td>
                            <a th:href="'https://wa.me/' + ${#strings.replace(a.clientPhone, ' ', '')?.replaceAll('[^0-9]', '')}"
                               target="_blank" class="text-decoration-none" title="Enviar WhatsApp">
                                <i class="bi bi-whatsapp text-success me-1"></i>
                                <span th:text="${a.clientPhone}">+34 600 123 456</span>
                            </a>
                        </td>
                        <td>
                            <span th:text="${a.notes ?: 'Sin notas'}"
                                  th:title="${a.notes}"
                                  style="display: inline-block; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                -
                            </span>
                        </td>
                        <td>
                            <small class="text-muted" th:text="${a.createdAt != null ? #temporals.format(a.createdAt, 'dd/MM/yyyy HH:mm') : '-'}">30/01/2026 14:23</small>
                        </td>
                        <td>
                            <span class="status-badge"
                                  th:classappend="${a.status?.name()?.toLowerCase() ?: 'pending'}"
                                  th:text="${a.status?.getDisplayName('es')} ?: 'Pendiente'">
                                Pendiente
                            </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-success btn-sm quick-status-btn" title="Marcar completado"
                                        th:data-id="${a.id}"
                                        data-status="COMPLETED"
                                        data-status-text="Completado">
                                    <i class="bi bi-check-lg"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm quick-status-btn" title="No se presentó"
                                        th:data-id="${a.id}"
                                        data-status="NO_SHOW"
                                        data-status-text="No se presento">
                                    <i class="bi bi-person-x"></i>
                                </button>
                                <button class="btn btn-admin-primary btn-sm" title="Ver detalles"
                                        onclick="openAppointmentModal(this.closest('tr'))">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- TODOS LOS TURNOS -->
    <div class="admin-card mb-5" id="todos-turnos">
        <div class="admin-card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
                <i class="bi bi-calendar3 me-2"></i>
                Todos los turnos
            </h4>
            <span class="badge bg-light text-dark fs-6">
                Total: <span id="totalBadge" th:text="${allAppointments.size()}">0</span>
            </span>
        </div>
        <div class="admin-card-body">

            <!-- FILTROS -->
            <div class="filters-card">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label">
                            <i class="bi bi-calendar-range me-1"></i>
                            Fecha Inicio
                        </label>
                        <input type="date" class="form-control" id="filterStartDate">
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">
                            <i class="bi bi-calendar-check me-1"></i>
                            Fecha Fin
                        </label>
                        <input type="date" class="form-control" id="filterEndDate">
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">
                            <i class="bi bi-funnel me-1"></i>
                            Estado
                        </label>
                        <select class="form-select" id="filterStatus">
                            <option value="ALL">Todos los estados</option>
                            <option value="PENDING">Pendiente</option>
                            <option value="CONFIRMED">Confirmado</option>
                            <option value="COMPLETED">Completado</option>
                            <option value="CANCELLED">Cancelado</option>
                            <option value="NO_SHOW">No se presentó</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <button class="btn btn-admin-primary w-100" onclick="applyFilters()">
                            <i class="bi bi-filter me-2"></i>
                            Aplicar Filtros
                        </button>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12 d-flex gap-2">
                        <button class="btn btn-admin-secondary btn-sm" onclick="clearFilters()">
                            <i class="bi bi-x-circle me-1"></i>
                            Limpiar Filtros
                        </button>
                        <button class="btn btn-admin-success btn-sm" onclick="exportToExcel()">
                            <i class="bi bi-file-earmark-excel me-1"></i>
                            Excel
                        </button>
                        <button class="btn btn-admin-secondary btn-sm" onclick="exportToCsv()">
                            <i class="bi bi-filetype-csv me-1"></i>
                            CSV
                        </button>
                    </div>
                </div>
            </div>

            <!-- Controles de tabla -->
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-3">
                <div class="d-flex align-items-center gap-2">
                    <label class="mb-0 text-muted small">Mostrar</label>
                    <select class="form-select form-select-sm" id="pageSize" style="width: auto;">
                        <option value="5" selected>5</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <label class="mb-0 text-muted small">registros</label>
                </div>

                <div style="max-width: 300px;">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" class="form-control border-start-0" id="searchInput"
                               placeholder="Buscar...">
                    </div>
                </div>
            </div>

            <div th:if="${allAppointments.isEmpty()}" class="text-center py-5">
                <i class="bi bi-calendar-x display-1" style="color: var(--tf-text-tertiary);"></i>
                <p class="mt-3 fs-5 text-muted">No tienes turnos registrados todavía</p>
            </div>

            <div class="table-responsive" th:unless="${allAppointments.isEmpty()}">
                <table class="admin-table" id="appointmentsTable">
                    <thead>
                    <tr>
                        <th data-sortable="date" class="sorted">
                            Fecha <i class="bi bi-arrow-down sort-icon"></i>
                        </th>
                        <th data-sortable="time">
                            Hora <i class="bi bi-arrow-down-up sort-icon"></i>
                        </th>
                        <th data-sortable="client">
                            Cliente <i class="bi bi-arrow-down-up sort-icon"></i>
                        </th>
                        <th>Teléfono</th>
                        <th>Notas</th>
                        <th data-sortable="createdAt">
                            Reservado el <i class="bi bi-arrow-down-up sort-icon"></i>
                        </th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                    </thead>
                    <tbody id="appointments-body">
                    <tr th:each="a : ${allAppointments}"
                        th:attr="data-id=${a.id},
                                 data-date=${a.date},
                                 data-time=${a.time},
                                 data-client=${a.clientName},
                                 data-phone=${a.clientPhone},
                                 data-email=${a.clientEmail ?: ''},
                                 data-notes=${a.notes ?: ''},
                                 data-internal-notes=${a.internalNotes ?: ''},
                                 data-service-id=${a.service?.id ?: ''},
                                 data-status=${a.status != null ? a.status.name() : 'PENDING'},
                                 data-created-at=${a.createdAt != null ? #temporals.format(a.createdAt, 'yyyy-MM-dd HH:mm:ss') : ''}">
                        <td><strong th:text="${a.date}">2025-12-12</strong></td>
                        <td><strong th:text="${a.time}">10:00</strong></td>
                        <td th:text="${a.clientName}">Juan Pérez</td>
                        <td th:text="${a.clientPhone}">+34 600 123 456</td>
                        <td>
                            <span th:text="${a.notes ?: 'Sin notas'}"
                                  th:title="${a.notes}"
                                  style="display: inline-block; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                -
                            </span>
                        </td>
                        <td>
                            <small class="text-muted" th:text="${a.createdAt != null ? #temporals.format(a.createdAt, 'dd/MM/yyyy HH:mm') : '-'}">30/01/2026 14:23</small>
                        </td>
                        <td>
                            <span class="status-badge"
                                  th:classappend="${a.status?.name()?.toLowerCase() ?: 'pending'}"
                                  th:text="${a.status?.getDisplayName('es')} ?: 'Pendiente'">
                                Pendiente
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-admin-primary btn-sm" onclick="openAppointmentModal(this.closest('tr'))">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Paginación client-side -->
            <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap gap-3" id="paginationContainer"
                 th:if="${!allAppointments.isEmpty()}">
                <div class="text-muted small" id="paginationInfo">
                    Mostrando <strong id="showingFrom">1</strong>
                    a <strong id="showingTo">5</strong>
                    de <strong id="totalRecords" th:text="${allAppointments.size()}">0</strong> registros
                </div>
                <nav>
                    <ul class="pagination admin-pagination mb-0" id="paginationNav">
                        <!-- Se genera dinámicamente con JavaScript -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- CALENDARIO -->
    <div class="admin-card">
        <div class="admin-card-header">
            <h4>
                <i class="bi bi-calendar-week me-2"></i>
                Calendario de turnos
            </h4>
        </div>
        <div class="admin-card-body">
            <div class="calendar-container">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL -->
<div class="modal fade admin-modal" id="appointmentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-calendar-check me-2"></i>
                    Detalles del Turno
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="appointmentForm">
                    <input type="hidden" id="appointmentId">

                    <div class="row g-4">
                        <div class="col-12">
                            <h6 class="fw-bold mb-3" style="color: var(--tf-brand);">
                                <i class="bi bi-person-circle me-2"></i>
                                Información del Cliente
                            </h6>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Cliente</label>
                            <input type="text" class="form-control" id="clientName" readonly>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Teléfono</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="clientPhone" readonly>
                                <a href="#" id="whatsappLink" class="btn btn-admin-success" target="_blank">
                                    <i class="bi bi-whatsapp"></i>
                                </a>
                            </div>
                        </div>

                        <div class="col-12">
                            <label class="form-label fw-bold">Email</label>
                            <input type="email" class="form-control" id="clientEmail" readonly>
                        </div>

                        <div class="col-12 mt-4">
                            <h6 class="fw-bold mb-3" style="color: var(--tf-brand);">
                                <i class="bi bi-calendar3 me-2"></i>
                                Información del Turno
                            </h6>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Fecha</label>
                            <input type="date" class="form-control" id="appointmentDate">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Hora</label>
                            <input type="time" class="form-control" id="appointmentTime">
                        </div>

                        <div class="col-12">
                            <label class="form-label fw-bold">Servicio</label>
                            <select class="form-select" id="appointmentService">
                                <option value="">Sin servicio</option>
                                <option th:each="s : ${services}" th:value="${s.id}" th:text="${s.name}">Servicio</option>
                            </select>
                        </div>

                        <div class="col-12">
                            <label class="form-label fw-bold">Notas del cliente</label>
                            <textarea class="form-control" id="appointmentNotes" rows="2"></textarea>
                        </div>

                        <div class="col-12">
                            <label class="form-label fw-bold">
                                <i class="bi bi-lock me-1"></i>Notas internas
                                <small class="text-muted fw-normal">(solo visibles para ti)</small>
                            </label>
                            <textarea class="form-control" id="appointmentInternalNotes" rows="2"
                                      placeholder="Ej: Cliente habitual, prefiere turno temprano..."></textarea>
                        </div>

                        <div class="col-12 mt-4">
                            <h6 class="fw-bold mb-3" style="color: var(--tf-brand);">
                                <i class="bi bi-flag me-2"></i>
                                Estado del Turno
                            </h6>
                        </div>

                        <div class="col-12">
                            <label class="form-label fw-bold">Cambiar estado</label>
                            <select class="form-select form-select-lg" id="appointmentStatus">
                                <option value="PENDING">Pendiente</option>
                                <option value="CONFIRMED">Confirmado</option>
                                <option value="COMPLETED">Completado</option>
                                <option value="CANCELLED">Cancelado</option>
                                <option value="NO_SHOW">No se presentó</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-admin-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Cerrar
                </button>
                <button type="button" class="btn btn-admin-primary" onclick="saveAppointmentStatus()">
                    <i class="bi bi-check-circle me-2"></i>Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmar Cambio de Estado -->
<div class="modal fade admin-modal" id="statusConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">
                    <i class="bi bi-arrow-repeat me-2"></i>
                    Cambiar Estado
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <p class="mb-1">¿Cambiar el estado del turno a</p>
                <p class="fw-bold fs-5" id="statusConfirmText"></p>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-admin-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-admin-primary" id="confirmStatusBtn">
                    <i class="bi bi-check-circle me-2"></i>Confirmar
                </button>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        initTablePagination();
        initCalendar();
        initTrendsChart();
    });

    function initTrendsChart() {
        const canvas = document.getElementById('trendsChart');
        if (!canvas) return;

        fetch('/admin/api/trends', {
            headers: {
                'Accept': 'application/json',
                'X-XSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.content || ''
            }
        })
        .then(r => r.json())
        .then(data => {
            // Agrupar por semana para mejor legibilidad
            const weekLabels = [];
            const weekData = [];
            let weekSum = 0;
            let weekStart = null;

            data.labels.forEach((label, i) => {
                const d = new Date(label);
                if (d.getDay() === 1 || i === 0) {
                    if (weekStart !== null) {
                        weekLabels.push(weekStart);
                        weekData.push(weekSum);
                    }
                    weekStart = d.toLocaleDateString('es-ES', { day: '2-digit', month: 'short' });
                    weekSum = 0;
                }
                weekSum += data.data[i];
            });
            if (weekStart) {
                weekLabels.push(weekStart);
                weekData.push(weekSum);
            }

            new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: weekLabels,
                    datasets: [{
                        label: 'Citas por semana',
                        data: weekData,
                        backgroundColor: 'rgba(201, 162, 39, 0.6)',
                        borderColor: '#c9a227',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1, color: '#999' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        x: {
                            ticks: { color: '#999' },
                            grid: { display: false }
                        }
                    }
                }
            });
        })
        .catch(err => console.warn('Error cargando tendencias:', err));
    }

    // Paginación client-side
    let tablePagination = {
        currentPage: 0,
        pageSize: 5,
        allRows: [],
        filteredRows: []
    };

    function initTablePagination() {
        const tbody = document.getElementById('appointments-body');
        if (!tbody) return;

        // Guardar todas las filas
        tablePagination.allRows = Array.from(tbody.querySelectorAll('tr'));
        tablePagination.filteredRows = [...tablePagination.allRows];

        // Evento para cambiar tamaño de página
        const pageSizeSelect = document.getElementById('pageSize');
        if (pageSizeSelect) {
            pageSizeSelect.addEventListener('change', function() {
                tablePagination.pageSize = parseInt(this.value);
                tablePagination.currentPage = 0;
                renderTablePage();
            });
        }

        // Evento para buscar
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const term = this.value.toLowerCase().trim();
                if (term === '') {
                    tablePagination.filteredRows = [...tablePagination.allRows];
                } else {
                    tablePagination.filteredRows = tablePagination.allRows.filter(row =>
                        row.textContent.toLowerCase().includes(term)
                    );
                }
                tablePagination.currentPage = 0;
                renderTablePage();
            });
        }

        // Render inicial
        renderTablePage();
    }

    function renderTablePage() {
        const tbody = document.getElementById('appointments-body');
        if (!tbody) return;

        const { currentPage, pageSize, filteredRows } = tablePagination;
        const totalRows = filteredRows.length;
        const totalPages = Math.ceil(totalRows / pageSize);
        const start = currentPage * pageSize;
        const end = Math.min(start + pageSize, totalRows);

        // Ocultar todas las filas primero
        tablePagination.allRows.forEach(row => row.style.display = 'none');

        // Mostrar solo las filas de la página actual
        for (let i = start; i < end; i++) {
            filteredRows[i].style.display = '';
        }

        // Actualizar info de paginación
        document.getElementById('showingFrom').textContent = totalRows > 0 ? start + 1 : 0;
        document.getElementById('showingTo').textContent = end;
        document.getElementById('totalRecords').textContent = totalRows;

        // Generar botones de paginación
        renderPaginationButtons(totalPages);
    }

    function renderPaginationButtons(totalPages) {
        const nav = document.getElementById('paginationNav');
        if (!nav) return;

        const { currentPage } = tablePagination;
        let html = '';

        // Botón anterior
        html += `<li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="goToPage(${currentPage - 1}); return false;">
                <i class="bi bi-chevron-left"></i>
            </a>
        </li>`;

        // Números de página
        for (let i = 0; i < totalPages; i++) {
            if (i === 0 || i === totalPages - 1 || (i >= currentPage - 2 && i <= currentPage + 2)) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i + 1}</a>
                </li>`;
            }
        }

        // Botón siguiente
        html += `<li class="page-item ${currentPage >= totalPages - 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="goToPage(${currentPage + 1}); return false;">
                <i class="bi bi-chevron-right"></i>
            </a>
        </li>`;

        nav.innerHTML = html;
    }

    function goToPage(page) {
        const totalPages = Math.ceil(tablePagination.filteredRows.length / tablePagination.pageSize);
        if (page < 0 || page >= totalPages) return;
        tablePagination.currentPage = page;
        renderTablePage();
    }

    function applyFilters() {
        // Los filtros de fecha/estado redirigen al server
        const startDate = document.getElementById('filterStartDate').value;
        const endDate = document.getElementById('filterEndDate').value;
        const status = document.getElementById('filterStatus').value;
        showToast('Filtros aplicados', 'success');
    }

    function clearFilters() {
        document.getElementById('filterStartDate').value = '';
        document.getElementById('filterEndDate').value = '';
        document.getElementById('filterStatus').value = 'ALL';
        document.getElementById('searchInput').value = '';
        // Resetear paginación
        tablePagination.filteredRows = [...tablePagination.allRows];
        tablePagination.currentPage = 0;
        renderTablePage();
        showToast('Filtros limpiados', 'success');
    }

    function getExportParams() {
        const startDate = document.getElementById('filterStartDate').value;
        const endDate = document.getElementById('filterEndDate').value;
        const status = document.getElementById('filterStatus').value;
        const params = [];
        if (startDate) params.push(`startDate=${startDate}`);
        if (endDate) params.push(`endDate=${endDate}`);
        if (status && status !== 'ALL') params.push(`status=${status}`);
        return params.join('&');
    }

    function exportToExcel() {
        showToast('Descargando Excel...', 'success');
        window.location.href = '/admin/appointments/export?' + getExportParams();
    }

    function exportToCsv() {
        showToast('Descargando CSV...', 'success');
        window.location.href = '/admin/appointments/export-csv?' + getExportParams();
    }

    function initCalendar() {
        var calendarEl = document.getElementById('calendar');
        if (!calendarEl) return;

        var rawAppointments = /*[[${calendarEvents}]]*/ [];
        var rawBlockedEvents = /*[[${blockedEvents}]]*/ [];

        // Convertir turnos a eventos de Toast UI Calendar
        var appointmentEvents = rawAppointments.map((a, idx) => {
            const status = a.status;
            let color = '#C9A227'; // Dorado por defecto
            if (status) {
                switch (status.badgeClass) {
                    case 'bg-success': color = '#5A9367'; break;
                    case 'bg-warning': color = '#C9A227'; break;
                    case 'bg-danger': color = '#C45C4A'; break;
                    case 'bg-dark': color = '#4A3F35'; break;
                    case 'bg-secondary': color = '#6B7280'; break;
                    default: color = '#C9A227';
                }
            }

            // Calcular hora de fin basada en la duración
            const duration = a.duration || 30; // 30 minutos por defecto
            // Asegurar formato correcto de hora (HH:mm:ss)
            const timeStr = a.time.length === 5 ? a.time + ':00' : a.time;
            const startDateTime = a.date + 'T' + timeStr;
            const startDate = new Date(startDateTime);
            const endDate = new Date(startDate.getTime() + duration * 60000);
            const endTime = endDate.toTimeString().substring(0, 8);

            return {
                id: 'appt-' + a.id,
                calendarId: 'appointments',
                title: a.clientName,
                start: startDateTime,
                end: a.date + 'T' + endTime,
                isReadOnly: true,
                category: 'time',
                backgroundColor: color,
                borderColor: color,
                color: '#fff',
                raw: {
                    id: a.id,
                    phone: a.clientPhone,
                    email: a.clientEmail || '',
                    status: status?.es || 'Sin estado',
                    statusCode: a.statusCode || 'PENDING',
                    notes: a.notes || '',
                    internalNotes: a.internalNotes || '',
                    serviceId: a.serviceId || '',
                    date: a.date,
                    time: a.time,
                    isBlocked: false
                }
            };
        });

        // Convertir bloqueos a eventos
        var blockedEvents = rawBlockedEvents.flatMap((b, idx) => {
            const events = [];
            const startDate = new Date(b.startDate);
            const endDate = new Date(b.endDate);

            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const bgColor = b.color || '#6B7280';

                if (b.allDay) {
                    // Para bloqueos de día completo
                    events.push({
                        id: 'blocked-' + idx + '-' + dateStr,
                        calendarId: 'blocked',
                        title: b.title,
                        start: dateStr + 'T08:00:00',
                        end: dateStr + 'T21:00:00',
                        isAllDay: false,
                        isReadOnly: true,
                        category: 'time',
                        backgroundColor: bgColor,
                        borderColor: bgColor,
                        color: '#ffffff',
                        raw: { isBlocked: true, type: b.typeDisplay }
                    });
                } else if (b.startTime && b.endTime) {
                    events.push({
                        id: 'blocked-' + idx + '-' + dateStr,
                        calendarId: 'blocked',
                        title: b.title,
                        start: dateStr + 'T' + b.startTime + ':00',
                        end: dateStr + 'T' + b.endTime + ':00',
                        isReadOnly: true,
                        category: 'time',
                        backgroundColor: bgColor,
                        borderColor: bgColor,
                        color: '#ffffff',
                        raw: { isBlocked: true, type: b.typeDisplay }
                    });
                }
            }
            return events;
        });

        // Combinar todos los eventos
        var allEvents = [...appointmentEvents, ...blockedEvents];

        // Crear controles de navegacion
        const controlsHtml = `
            <div class="tui-calendar-controls admin-cal-controls">
                <div class="tui-nav-buttons">
                    <button type="button" class="btn-cal-nav" id="adminCalPrev">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <button type="button" class="btn-cal-today" id="adminCalToday">Hoy</button>
                    <button type="button" class="btn-cal-nav" id="adminCalNext">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
                <h3 class="tui-calendar-title" id="adminCalTitle"></h3>
                <div class="tui-view-buttons">
                    <button type="button" class="btn-cal-view active" data-view="month">Mes</button>
                    <button type="button" class="btn-cal-view" data-view="week">Semana</button>
                    <button type="button" class="btn-cal-view" data-view="day">Dia</button>
                </div>
            </div>
        `;
        calendarEl.insertAdjacentHTML('beforebegin', controlsHtml);

        // Crear calendario Toast UI
        const Calendar = tui.Calendar;
        const calendar = new Calendar(calendarEl, {
            defaultView: 'month',
            usageStatistics: false,
            isReadOnly: true,
            useDetailPopup: false,
            useFormPopup: false,
            week: {
                startDayOfWeek: 1,
                dayNames: ['Dom', 'Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab'],
                hourStart: 8,
                hourEnd: 21,
                taskView: false,
                eventView: ['allday', 'time'],
                showNowIndicator: true
            },
            month: {
                startDayOfWeek: 1,
                dayNames: ['Dom', 'Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab'],
                narrowWeekend: false,
                visibleWeeksCount: 0,
                visibleEventCount: 4
            },
            calendars: [
                {
                    id: 'appointments',
                    name: 'Turnos',
                    backgroundColor: '#C9A227',
                    borderColor: '#C9A227',
                    color: '#ffffff'
                },
                {
                    id: 'blocked',
                    name: 'Bloqueados',
                    backgroundColor: '#6B7280',
                    borderColor: '#6B7280',
                    color: '#ffffff'
                }
            ],
            theme: {
                common: {
                    backgroundColor: '#ffffff',
                    border: '1px solid #e5e7eb',
                    dayName: { color: '#374151' },
                    holiday: { color: '#C45C4A' },
                    saturday: { color: '#6366f1' },
                    today: { color: '#D4AF74' },
                    gridSelection: {
                        backgroundColor: 'rgba(212, 175, 116, 0.3)',
                        border: '2px solid #D4AF74'
                    }
                },
                week: {
                    dayName: {
                        borderLeft: '1px solid #e5e7eb',
                        borderTop: '1px solid #e5e7eb',
                        borderBottom: '2px solid #D4AF74',
                        backgroundColor: '#f9fafb'
                    },
                    dayGrid: { borderRight: '1px solid #e5e7eb' },
                    dayGridLeft: {
                        borderRight: '1px solid #e5e7eb',
                        backgroundColor: '#f9fafb',
                        width: '60px'
                    },
                    timeGrid: { borderRight: '1px solid #e5e7eb' },
                    timeGridLeft: {
                        borderRight: '1px solid #e5e7eb',
                        backgroundColor: '#f9fafb',
                        width: '60px'
                    },
                    timeGridHalfHourLine: { borderBottom: '1px dotted #e5e7eb' },
                    timeGridHourLine: { borderBottom: '1px solid #d1d5db' },
                    nowIndicatorLabel: { color: '#D4AF74' },
                    nowIndicatorBullet: { backgroundColor: '#D4AF74' },
                    nowIndicatorToday: { border: '2px solid #D4AF74' },
                    pastTime: { color: '#9ca3af' },
                    futureTime: { color: '#374151' }
                },
                month: {
                    dayName: {
                        borderLeft: '1px solid #e5e7eb',
                        backgroundColor: '#f9fafb'
                    },
                    holidayExceptThisMonth: { color: 'rgba(196, 92, 74, 0.4)' },
                    dayExceptThisMonth: { color: '#d1d5db' },
                    moreView: {
                        backgroundColor: '#ffffff',
                        border: '1px solid #e5e7eb'
                    },
                    moreViewTitle: { backgroundColor: '#f9fafb' }
                }
            },
            template: {
                time: function(event) {
                    const time = new Date(event.start).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit', hour12: false});
                    return '<span style="color: ' + (event.color || '#fff') + '; font-weight: 500;">' + time + ' ' + event.title + '</span>';
                },
                allday: function(event) {
                    return '<span style="color: ' + (event.color || '#fff') + '; font-weight: 500;">' + event.title + '</span>';
                },
                monthGridHeader: function(model) {
                    const date = parseInt(model.date.split('-')[2], 10);
                    const isToday = model.isToday;
                    const style = isToday ? 'background: #D4AF74; color: #fff; border-radius: 50%; width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center; font-weight: 600;' : 'color: #374151;';
                    return '<span style="' + style + '">' + date + '</span>';
                },
                timegridDisplayPrimaryTime: function(props) {
                    const hour = props.time.getHours();
                    const minutes = props.time.getMinutes();
                    return (hour < 10 ? '0' : '') + hour + ':' + (minutes < 10 ? '0' : '') + minutes;
                },
                timegridNowIndicatorLabel: function(props) {
                    const hour = props.time.getHours();
                    const minutes = props.time.getMinutes();
                    return (hour < 10 ? '0' : '') + hour + ':' + (minutes < 10 ? '0' : '') + minutes;
                },
                monthMoreTitleDate: function(moreTitle) {
                    const date = new Date(moreTitle.ymd);
                    const day = date.getDate();
                    const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                    return '<span style="font-weight: 600; color: #374151;">' + day + ' ' + months[date.getMonth()] + '</span>';
                },
                monthMoreClose: function() {
                    return '<i class="bi bi-x-lg"></i>';
                }
            }
        });

        // Cargar eventos
        console.log('Cargando eventos en calendario:', allEvents.length, 'eventos');
        console.log('Turnos:', appointmentEvents.length);
        console.log('Bloqueos:', blockedEvents.length);
        if (allEvents.length > 0) {
            console.log('Ejemplo de evento:', allEvents[0]);
        }
        calendar.createEvents(allEvents);

        // Actualizar titulo inicial
        updateAdminCalendarTitle(calendar);

        // Event listeners para navegacion
        document.getElementById('adminCalPrev').addEventListener('click', () => {
            calendar.prev();
            updateAdminCalendarTitle(calendar);
        });
        document.getElementById('adminCalNext').addEventListener('click', () => {
            calendar.next();
            updateAdminCalendarTitle(calendar);
        });
        document.getElementById('adminCalToday').addEventListener('click', () => {
            calendar.today();
            updateAdminCalendarTitle(calendar);
        });

        document.querySelectorAll('.admin-cal-controls .btn-cal-view').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.admin-cal-controls .btn-cal-view').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                calendar.changeView(this.dataset.view);
                updateAdminCalendarTitle(calendar);
            });
        });

        // Click en evento
        calendar.on('clickEvent', function(info) {
            const event = info.event;
            const raw = event.raw || {};

            if (raw.isBlocked) {
                alert('Bloqueo: ' + event.title + ' (' + raw.type + ')');
                return;
            }
            openCalendarModal(event.title, raw);
        });

        function updateAdminCalendarTitle(cal) {
            const date = cal.getDate().toDate();
            const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                           'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            document.getElementById('adminCalTitle').textContent = months[date.getMonth()] + ' ' + date.getFullYear();
        }
    }

    function openCalendarModal(clientName, props) {
        document.getElementById('appointmentId').value = props.id || '';
        document.getElementById('clientName').value = clientName;
        document.getElementById('clientPhone').value = props.phone;
        document.getElementById('clientEmail').value = props.email || '';
        document.getElementById('appointmentDate').value = props.date;
        document.getElementById('appointmentTime').value = props.time;
        document.getElementById('appointmentNotes').value = props.notes || '';
        document.getElementById('appointmentInternalNotes').value = props.internalNotes || '';
        document.getElementById('appointmentStatus').value = props.statusCode || 'PENDING';
        if (document.getElementById('appointmentService')) {
            document.getElementById('appointmentService').value = props.serviceId || '';
        }

        const cleanPhone = props.phone.replace(/\D/g, '');
        document.getElementById('whatsappLink').href = 'https://wa.me/' + cleanPhone;

        new bootstrap.Modal(document.getElementById('appointmentModal')).show();
    }

    function formatDateSpanish(dateStr) {
        if (!dateStr) return '';
        const months = ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic'];
        const parts = dateStr.split('-');
        if (parts.length !== 3) return dateStr;
        const day = parseInt(parts[2], 10);
        const month = months[parseInt(parts[1], 10) - 1];
        const year = parts[0];
        return day + ' ' + month + ' ' + year;
    }

    function copyLink() {
        const link = document.getElementById('publicLink');
        link.select();
        navigator.clipboard.writeText(link.value).then(() => {
            showToast('Enlace copiado', 'success');
        });
    }

    function openAppointmentModal(row) {
        document.getElementById('appointmentId').value = row.dataset.id;
        document.getElementById('clientName').value = row.dataset.client;
        document.getElementById('clientPhone').value = row.dataset.phone;
        document.getElementById('clientEmail').value = row.dataset.email || '';
        document.getElementById('appointmentDate').value = row.dataset.date;
        document.getElementById('appointmentTime').value = row.dataset.time;
        document.getElementById('appointmentNotes').value = row.dataset.notes || '';
        document.getElementById('appointmentInternalNotes').value = row.dataset.internalNotes || '';
        document.getElementById('appointmentStatus').value = row.dataset.status || 'PENDING';
        if (document.getElementById('appointmentService')) {
            document.getElementById('appointmentService').value = row.dataset.serviceId || '';
        }

        const cleanPhone = row.dataset.phone.replace(/\D/g, '');
        document.getElementById('whatsappLink').href = `https://wa.me/${cleanPhone}`;

        new bootstrap.Modal(document.getElementById('appointmentModal')).show();
    }

    function getHeaders() {
        const headers = { 'Content-Type': 'application/json' };
        const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
        if (csrfToken && csrfHeader) {
            headers[csrfHeader] = csrfToken;
        }
        return headers;
    }

    // Variables para el modal de confirmación de estado
    let pendingStatusChange = { id: null, status: null };

    // Event delegation para botones de cambio rápido de estado
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.quick-status-btn');
        if (btn) {
            pendingStatusChange.id = btn.dataset.id;
            pendingStatusChange.status = btn.dataset.status;
            document.getElementById('statusConfirmText').textContent = btn.dataset.statusText + '?';
            new bootstrap.Modal(document.getElementById('statusConfirmModal')).show();
        }
    });

    // Confirmar cambio de estado
    document.getElementById('confirmStatusBtn').addEventListener('click', async function() {
        const { id, status } = pendingStatusChange;
        if (!id || !status) return;

        try {
            const response = await fetch('/admin/appointments/' + id + '/status', {
                method: 'PATCH',
                headers: getHeaders(),
                body: JSON.stringify({ status: status })
            });

            bootstrap.Modal.getInstance(document.getElementById('statusConfirmModal')).hide();

            if (response.ok) {
                showToast('Estado actualizado', 'success');
                setTimeout(() => window.location.reload(), 800);
            } else {
                showToast('Error al actualizar', 'error');
            }
        } catch (error) {
            showToast('Error al actualizar', 'error');
        }
    });

    async function saveAppointmentStatus() {
        const id = document.getElementById('appointmentId').value;
        const newStatus = document.getElementById('appointmentStatus').value;

        if (!id) {
            showToast('No se puede guardar sin ID', 'error');
            return;
        }

        try {
            // Guardar edición del turno (fecha, hora, notas, etc.)
            const editPayload = {
                date: document.getElementById('appointmentDate').value,
                time: document.getElementById('appointmentTime').value,
                serviceId: document.getElementById('appointmentService')?.value || '',
                notes: document.getElementById('appointmentNotes').value,
                internalNotes: document.getElementById('appointmentInternalNotes').value
            };

            const editResponse = await fetch('/admin/appointments/' + id, {
                method: 'PUT',
                headers: getHeaders(),
                body: JSON.stringify(editPayload)
            });

            if (!editResponse.ok) {
                const data = await editResponse.json();
                showToast(data.message || 'Error al guardar cambios', 'error');
                return;
            }

            // Guardar estado
            const statusResponse = await fetch('/admin/appointments/' + id + '/status', {
                method: 'PATCH',
                headers: getHeaders(),
                body: JSON.stringify({ status: newStatus })
            });

            if (statusResponse.ok) {
                bootstrap.Modal.getInstance(document.getElementById('appointmentModal')).hide();
                showToast('Turno actualizado', 'success');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showToast('Error al actualizar estado', 'error');
            }
        } catch (error) {
            showToast('Error al actualizar', 'error');
        }
    }

    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `admin-toast ${type}`;
        toast.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle-fill' : 'x-circle-fill'}"></i>${message}`;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.animation = 'slideOutRight 0.3s ease-out';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script th:src="@{/js/notifications.js}"></script>

</body>
</html>
