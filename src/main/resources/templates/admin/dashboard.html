<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <th:block th:replace="fragments/head :: favicons" />
    <meta charset="UTF-8">
    <title>Dashboard â€“ TurnoFÃ¡cil</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <link th:replace="fragments/navbar :: navbar-css">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .navbar-brand { font-weight: 800; font-size: 1.6rem; }
        .avatar { width: 42px; height: 42px; background: #fff; color: #667eea; border-radius: 50%; font-weight: bold; display: flex; align-items: center; justify-content: center; }
        .card { border: none; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .card-header { background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 2rem; }
        #calendar { height: 700px; padding: 20px; background: white; border-radius: 16px; }
        .fc-button-primary { background: #667eea !important; border: none !important; }
        .badge { font-size: 0.9em; padding: 0.6em 1em; }

        /* Estilos mejorados para eventos del calendario */
        .fc-event {
          cursor: pointer;
          border-radius: 4px;
          padding: 2px 4px;
          margin-bottom: 2px;
          font-size: 0.85em;
          font-weight: 500;
        }
        .fc-event:hover {
          opacity: 0.8;
          transform: scale(1.02);
          transition: all 0.2s;
        }
        .fc-daygrid-event {
          white-space: normal;
        }
        .fc-event-title {
          overflow: hidden;
          text-overflow: ellipsis;
        }

        /* Estilos de paginaciÃ³n y tabla */
        .pagination-info { color: #6c757d; font-size: 0.9rem; }
        .table-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
        .search-box { max-width: 300px; min-width: 200px; }
        tbody tr { cursor: pointer; transition: all 0.2s; }
        tbody tr:hover { background-color: #f8f9fa; transform: scale(1.005); }

        .sort-icon { opacity: 0.3; transition: opacity 0.2s; }
        th[data-sortable]:hover .sort-icon { opacity: 0.6; }
        th[data-sortable] { cursor: pointer; user-select: none; }
        th[data-sortable].sorted .sort-icon { opacity: 1; color: #667eea; }

        @media (max-width: 768px) {
          .table-controls { flex-direction: column; align-items: stretch; }
          .search-box { max-width: 100%; }
        }
    </style>
</head>
<body>

<!-- NAVBAR -->
<div th:replace="fragments/navbar :: navbar"></div>

<div class="container py-5">
    <h2 class="text-white mb-4 fw-light">Bienvenido, <strong th:text="${businessConfig.businessName}">Negocio S.L.</strong></h2>

    <!-- ENLACE PÃšBLICO -->
    <div class="card mb-5 border-0" style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px);">
        <div class="card-body text-center py-5">
            <i class="bi bi-link-45deg display-1 text-white mb-4"></i>
            <h3 class="text-white fw-bold mb-3">PÃ¡gina pÃºblica de reservas</h3>
            <p class="text-white opacity-90 mb-4 fs-5">
                Comparte este enlace con tus clientes para que reserven online
            </p>

            <div class="input-group input-group-lg w-75 mx-auto mb-4">
                <input type="text" class="form-control text-center fw-bold fs-5"
                       th:value="@{|http://localhost:8080/public/book/${businessConfig.slug}|}"
                       id="publicLink" readonly>
                <button class="btn btn-light fw-bold" onclick="copyLink()">
                    <i class="bi bi-clipboard me-2"></i>Copiar
                </button>
            </div>

            <a th:href="@{|/public/book/${businessConfig.slug}|}"
               target="_blank"
               class="btn btn-light btn-lg px-5 fw-bold">
                <i class="bi bi-box-arrow-up-right me-2"></i>Ver pÃ¡gina pÃºblica
            </a>
        </div>
    </div>

    <!-- KPIs / ESTADÃSTICAS -->
    <div class="row g-4 mb-5">
        <!-- Turnos Hoy -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center p-4">
                    <div class="d-flex justify-content-center align-items-center mb-3">
                        <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                            <i class="bi bi-calendar-day text-primary fs-1"></i>
                        </div>
                    </div>
                    <h3 class="fw-bold mb-1" th:text="${kpiTurnosHoy}">0</h3>
                    <p class="text-muted mb-0">Turnos Hoy</p>
                </div>
            </div>
        </div>

        <!-- Turnos Esta Semana -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center p-4">
                    <div class="d-flex justify-content-center align-items-center mb-3">
                        <div class="bg-info bg-opacity-10 rounded-circle p-3">
                            <i class="bi bi-calendar-week text-info fs-1"></i>
                        </div>
                    </div>
                    <h3 class="fw-bold mb-1" th:text="${kpiTurnosSemana}">0</h3>
                    <p class="text-muted mb-0">Esta Semana</p>
                </div>
            </div>
        </div>

        <!-- Turnos Completados -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center p-4">
                    <div class="d-flex justify-content-center align-items-center mb-3">
                        <div class="bg-success bg-opacity-10 rounded-circle p-3">
                            <i class="bi bi-check-circle text-success fs-1"></i>
                        </div>
                    </div>
                    <h3 class="fw-bold mb-1" th:text="${kpiCompletados}">0</h3>
                    <p class="text-muted mb-0">Completados</p>
                </div>
            </div>
        </div>

        <!-- Tasa de No-Show -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center p-4">
                    <div class="d-flex justify-content-center align-items-center mb-3">
                        <div class="bg-danger bg-opacity-10 rounded-circle p-3">
                            <i class="bi bi-exclamation-triangle text-danger fs-1"></i>
                        </div>
                    </div>
                    <h3 class="fw-bold mb-1">
                        <span th:text="${kpiTasaNoShow}">0</span>%
                    </h3>
                    <p class="text-muted mb-0">Tasa No-Show</p>
                </div>
            </div>
        </div>
    </div>

    <!-- EstadÃ­sticas Adicionales (barra de progreso) -->
    <div class="card mb-5 border-0 shadow-sm">
        <div class="card-body p-4">
            <h5 class="fw-bold mb-4">
                <i class="bi bi-graph-up me-2"></i>
                Resumen del Mes
            </h5>

            <div class="row g-4">
                <div class="col-md-3 text-center">
                    <div class="mb-2">
                        <i class="bi bi-calendar-check text-primary fs-3"></i>
                    </div>
                    <h4 class="fw-bold text-primary mb-1" th:text="${kpiTurnosMes}">0</h4>
                    <small class="text-muted">Total del Mes</small>
                </div>

                <div class="col-md-3 text-center">
                    <div class="mb-2">
                        <i class="bi bi-hourglass-split text-warning fs-3"></i>
                    </div>
                    <h4 class="fw-bold text-warning mb-1" th:text="${kpiPendientes}">0</h4>
                    <small class="text-muted">Pendientes</small>
                </div>

                <div class="col-md-3 text-center">
                    <div class="mb-2">
                        <i class="bi bi-x-circle text-danger fs-3"></i>
                    </div>
                    <h4 class="fw-bold text-danger mb-1" th:text="${kpiCancelados}">0</h4>
                    <small class="text-muted">Cancelados</small>
                </div>

                <div class="col-md-3 text-center">
                    <div class="mb-2">
                        <i class="bi bi-person-x text-dark fs-3"></i>
                    </div>
                    <h4 class="fw-bold text-dark mb-1" th:text="${kpiNoShow}">0</h4>
                    <small class="text-muted">No se presentaron</small>
                </div>
            </div>

            <!-- Barra de progreso visual -->
            <div class="mt-4">
                <div class="d-flex justify-content-between mb-2">
                    <small class="text-muted">Estado de los turnos</small>
                    <small class="text-muted">
                        <span th:text="${kpiCompletados}">0</span> de
                        <span th:text="${kpiTurnosMes}">0</span> completados
                    </small>
                </div>
                <div class="progress" style="height: 25px;">
                    <div class="progress-bar bg-success" role="progressbar"
                         th:style="'width: ' + ${kpiTurnosMes > 0 ? (kpiCompletados * 100.0 / kpiTurnosMes) : 0} + '%'"
                         th:attr="aria-valuenow=${kpiCompletados}, aria-valuemin=0, aria-valuemax=${kpiTurnosMes}">
            <span th:if="${kpiTurnosMes > 0}"
                  th:text="${#numbers.formatDecimal(kpiCompletados * 100.0 / kpiTurnosMes, 1, 1)} + '%'">0%</span>
                    </div>
                    <div class="progress-bar bg-warning" role="progressbar"
                         th:style="'width: ' + ${kpiTurnosMes > 0 ? (kpiPendientes * 100.0 / kpiTurnosMes) : 0} + '%'">
                    </div>
                    <div class="progress-bar bg-danger" role="progressbar"
                         th:style="'width: ' + ${kpiTurnosMes > 0 ? (kpiCancelados * 100.0 / kpiTurnosMes) : 0} + '%'">
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <small>
                        <span class="badge bg-success">Completados</span>
                        <span class="badge bg-warning">Pendientes</span>
                        <span class="badge bg-danger">Cancelados</span>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- TURNOS DE HOY -->
    <div class="card mb-5">
        <div class="card-header">
            <h4 class="mb-0 text-white">
                <i class="bi bi-calendar-day me-2"></i>
                Turnos de hoy â€“ <span th:text="${today}">2025-12-12</span>
            </h4>
        </div>
        <div class="card-body bg-white">
            <div th:if="${todayAppointments.isEmpty()}" class="text-center py-5 text-muted">
                <i class="bi bi-calendar-check display-1"></i>
                <p class="mt-3 fs-4">No tienes turnos hoy. Â¡DÃ­a tranquilo!</p>
            </div>

            <div class="table-responsive" th:unless="${todayAppointments.isEmpty()}">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                    <tr>
                        <th>Hora</th>
                        <th>Cliente</th>
                        <th>TelÃ©fono</th>
                        <th>Notas</th>
                        <th>Estado</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="a : ${todayAppointments}">
                        <td><strong th:text="${a.time}">10:00</strong></td>
                        <td th:text="${a.clientName}">Juan PÃ©rez</td>
                        <td th:text="${a.clientPhone}">+34 600 123 456</td>
                        <td th:text="${a.notes ?: 'Sin notas'}">-</td>
                        <td>
              <span class="badge rounded-pill px-4 py-2"
                    th:class="${a.status?.badgeClass} ?: 'bg-secondary'"
                    th:text="${a.status?.getDisplayName('es')} ?: 'Sin estado'">
                Pendiente
              </span>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- TODOS LOS TURNOS CON PAGINACIÃ“N Y FILTROS -->
    <div class="card mb-5">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0 text-white">
                <i class="bi bi-calendar3 me-2"></i>
                Todos los turnos
            </h4>
            <span class="badge bg-light text-dark fs-6">
        Total: <span id="totalBadge" th:text="${allAppointments.size()}">0</span>
      </span>
        </div>
        <div class="card-body bg-white">

            <!-- FILTROS AVANZADOS -->
            <div class="card bg-light mb-4">
                <div class="card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label fw-bold small">
                                <i class="bi bi-calendar-range me-1"></i>
                                Fecha Inicio
                            </label>
                            <input type="date" class="form-control" id="filterStartDate">
                        </div>

                        <div class="col-md-3">
                            <label class="form-label fw-bold small">
                                <i class="bi bi-calendar-check me-1"></i>
                                Fecha Fin
                            </label>
                            <input type="date" class="form-control" id="filterEndDate">
                        </div>

                        <div class="col-md-3">
                            <label class="form-label fw-bold small">
                                <i class="bi bi-funnel me-1"></i>
                                Estado
                            </label>
                            <select class="form-select" id="filterStatus">
                                <option value="ALL">Todos los estados</option>
                                <option value="PENDING">ðŸŸ¡ Pendiente</option>
                                <option value="CONFIRMED">ðŸŸ¢ Confirmado</option>
                                <option value="COMPLETED">âšª Completado</option>
                                <option value="CANCELLED">ðŸ”´ Cancelado</option>
                                <option value="NO_SHOW">âš« No se presentÃ³</option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <button class="btn btn-primary w-100" onclick="applyFilters()">
                                <i class="bi bi-filter me-2"></i>
                                Aplicar Filtros
                            </button>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-12 d-flex gap-2">
                            <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                                <i class="bi bi-x-circle me-1"></i>
                                Limpiar Filtros
                            </button>
                            <button class="btn btn-success btn-sm" onclick="exportToExcel()">
                                <i class="bi bi-file-earmark-excel me-1"></i>
                                Exportar a Excel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controles de tabla -->
            <div class="table-controls">
                <div class="d-flex align-items-center gap-2">
                    <label class="mb-0 text-muted small">Mostrar</label>
                    <select class="form-select form-select-sm" id="pageSize" style="width: auto;">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <label class="mb-0 text-muted small">registros</label>
                </div>

                <div class="search-box">
                    <div class="input-group">
            <span class="input-group-text bg-white border-end-0">
              <i class="bi bi-search"></i>
            </span>
                        <input type="text" class="form-control border-start-0" id="searchInput"
                               placeholder="Buscar por nombre, telÃ©fono, fecha...">
                    </div>
                </div>
            </div>

            <div th:if="${allAppointments.isEmpty()}" class="text-center py-5 text-muted">
                <i class="bi bi-calendar-x display-1"></i>
                <p class="mt-3 fs-4">No tienes turnos registrados todavÃ­a</p>
            </div>

            <div class="table-responsive" th:unless="${allAppointments.isEmpty()}">
                <table class="table table-hover align-middle" id="appointmentsTable">
                    <thead class="table-light">
                    <tr>
                        <th data-sortable="date" class="sorted">
                            Fecha <i class="bi bi-arrow-down sort-icon"></i>
                        </th>
                        <th data-sortable="time">
                            Hora <i class="bi bi-arrow-down-up sort-icon"></i>
                        </th>
                        <th data-sortable="client">
                            Cliente <i class="bi bi-arrow-down-up sort-icon"></i>
                        </th>
                        <th>TelÃ©fono</th>
                        <th>Notas</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                    </thead>
                    <tbody id="appointments-body">
                    <tr th:each="a : ${allAppointments}"
                        th:attr="data-id=${a.id},
                       data-date=${a.date},
                       data-time=${a.time},
                       data-client=${a.clientName},
                       data-phone=${a.clientPhone},
                       data-email=${a.clientEmail ?: ''},
                       data-notes=${a.notes ?: ''},
                       data-status=${a.status != null ? a.status.name() : 'PENDING'}">
                        <td><strong th:text="${a.date}">2025-12-12</strong></td>
                        <td><strong th:text="${a.time}">10:00</strong></td>
                        <td th:text="${a.clientName}">Juan PÃ©rez</td>
                        <td th:text="${a.clientPhone}">+34 600 123 456</td>
                        <td>
              <span th:text="${a.notes ?: 'Sin notas'}"
                    th:title="${a.notes}"
                    style="display: inline-block; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                -
              </span>
                        </td>
                        <td>
              <span class="badge rounded-pill px-3 py-2"
                    th:class="${a.status?.badgeClass} ?: 'bg-secondary'"
                    th:text="${a.status?.getDisplayName('es')} ?: 'Sin estado'">
                Pendiente
              </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="openAppointmentModal(this.closest('tr'))">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- PaginaciÃ³n -->
            <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap gap-3" id="paginationContainer">
                <div class="pagination-info">
                    Mostrando <strong><span id="showingFrom">1</span></strong> a <strong><span id="showingTo">10</span></strong>
                    de <strong><span id="totalRecords">0</span></strong> registros
                    <span id="filteredInfo" style="display: none;" class="text-muted">
            (filtrados de <span id="totalOriginal">0</span> registros totales)
          </span>
                </div>
                <nav>
                    <ul class="pagination mb-0" id="pagination">
                        <!-- Generado dinÃ¡micamente -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- CALENDARIO -->
    <div class="card">
        <div class="card-header">
            <h4 class="mb-0 text-white">
                <i class="bi bi-calendar-week me-2"></i>
                Calendario de turnos
            </h4>
        </div>
        <div class="card-body bg-white">
            <div id="calendar"></div>
        </div>
    </div>
</div>

<!-- MODAL DE DETALLES/EDICIÃ“N DE APPOINTMENT -->
<div class="modal fade" id="appointmentModal" tabindex="-1" aria-labelledby="appointmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-gradient" style="background: linear-gradient(45deg, #667eea, #764ba2);">
                <h5 class="modal-title text-white" id="appointmentModalLabel">
                    <i class="bi bi-calendar-check me-2"></i>
                    Detalles del Turno
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="appointmentForm">
                    <input type="hidden" id="appointmentId">

                    <div class="row g-4">
                        <!-- InformaciÃ³n del Cliente -->
                        <div class="col-12">
                            <h6 class="text-primary fw-bold mb-3">
                                <i class="bi bi-person-circle me-2"></i>
                                InformaciÃ³n del Cliente
                            </h6>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-person me-1"></i>
                                Cliente
                            </label>
                            <input type="text" class="form-control" id="clientName" readonly>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-telephone me-1"></i>
                                TelÃ©fono
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="clientPhone" readonly>
                                <a href="#" id="whatsappLink" class="btn btn-success" target="_blank">
                                    <i class="bi bi-whatsapp"></i>
                                </a>
                            </div>
                        </div>

                        <div class="col-12">
                            <label class="form-label fw-bold">
                                <i class="bi bi-envelope me-1"></i>
                                Email
                            </label>
                            <input type="email" class="form-control" id="clientEmail" readonly>
                        </div>

                        <!-- InformaciÃ³n del Turno -->
                        <div class="col-12 mt-4">
                            <h6 class="text-primary fw-bold mb-3">
                                <i class="bi bi-calendar3 me-2"></i>
                                InformaciÃ³n del Turno
                            </h6>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-calendar-event me-1"></i>
                                Fecha
                            </label>
                            <input type="text" class="form-control" id="appointmentDate" readonly>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-clock me-1"></i>
                                Hora
                            </label>
                            <input type="text" class="form-control" id="appointmentTime" readonly>
                        </div>

                        <div class="col-12">
                            <label class="form-label fw-bold">
                                <i class="bi bi-sticky me-1"></i>
                                Notas
                            </label>
                            <textarea class="form-control" id="appointmentNotes" rows="3" readonly></textarea>
                        </div>

                        <!-- Estado -->
                        <div class="col-12 mt-4">
                            <h6 class="text-primary fw-bold mb-3">
                                <i class="bi bi-flag me-2"></i>
                                Estado del Turno
                            </h6>
                        </div>

                        <div class="col-12">
                            <label class="form-label fw-bold">Cambiar estado</label>
                            <select class="form-select form-select-lg" id="appointmentStatus">
                                <option value="PENDING">ðŸŸ¡ Pendiente</option>
                                <option value="CONFIRMED">ðŸŸ¢ Confirmado</option>
                                <option value="COMPLETED">âšª Completado</option>
                                <option value="CANCELLED">ðŸ”´ Cancelado</option>
                                <option value="NO_SHOW">âš« No se presentÃ³</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>
                    Cerrar
                </button>
                <button type="button" class="btn btn-primary" onclick="saveAppointmentStatus()">
                    <i class="bi bi-check-circle me-2"></i>
                    Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    // Variables globales para paginaciÃ³n
    let allRows = [];
    let filteredRows = [];
    let currentPage = 1;
    let pageSize = 10;
    let sortColumn = 'date';
    let sortDirection = 'desc';

    document.addEventListener('DOMContentLoaded', function () {
      // Inicializar tabla
      initTable();

      // Inicializar calendario
      initCalendar();
    });

    function initTable() {
      const tbody = document.getElementById('appointments-body');
      if (!tbody) return;

      allRows = Array.from(tbody.querySelectorAll('tr'));
      filteredRows = [...allRows];

      // Event listeners
      document.getElementById('pageSize').addEventListener('change', function() {
        pageSize = parseInt(this.value);
        currentPage = 1;
        updateTable();
      });

      document.getElementById('searchInput').addEventListener('input', function() {
        applyAllFilters();
      });

      // Ordenamiento al hacer click en headers
      document.querySelectorAll('th[data-sortable]').forEach(th => {
        th.addEventListener('click', function() {
          const column = this.getAttribute('data-sortable');

          if (sortColumn === column) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
          } else {
            sortColumn = column;
            sortDirection = 'asc';
          }

          // Actualizar estilos de headers
          document.querySelectorAll('th[data-sortable]').forEach(h => {
            h.classList.remove('sorted');
            const icon = h.querySelector('.sort-icon');
            icon.className = 'bi bi-arrow-down-up sort-icon';
          });

          this.classList.add('sorted');
          const icon = this.querySelector('.sort-icon');
          icon.className = sortDirection === 'asc' ? 'bi bi-arrow-up sort-icon' : 'bi bi-arrow-down sort-icon';

          sortData(column, sortDirection);
          updateTable();
        });
      });

      // Ordenar por defecto y mostrar
      sortData('date', 'desc');
      updateTable();
    }

    function applyAllFilters() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
      const startDate = document.getElementById('filterStartDate').value;
      const endDate = document.getElementById('filterEndDate').value;
      const status = document.getElementById('filterStatus').value;

      filteredRows = allRows.filter(row => {
        // Filtro de bÃºsqueda
        const client = (row.dataset.client || '').toLowerCase();
        const phone = (row.dataset.phone || '').toLowerCase();
        const date = (row.dataset.date || '').toLowerCase();
        const time = (row.dataset.time || '').toLowerCase();

        const matchesSearch = searchTerm === '' ||
                             client.includes(searchTerm) ||
                             phone.includes(searchTerm) ||
                             date.includes(searchTerm) ||
                             time.includes(searchTerm);

        // Filtro de fecha inicio
        const matchesStartDate = !startDate || row.dataset.date >= startDate;

        // Filtro de fecha fin
        const matchesEndDate = !endDate || row.dataset.date <= endDate;

        // Filtro de estado
        const matchesStatus = status === 'ALL' || row.dataset.status === status;

        return matchesSearch && matchesStartDate && matchesEndDate && matchesStatus;
      });

      // Actualizar badge de total
      document.getElementById('totalBadge').textContent = filteredRows.length;

      if (searchTerm || startDate || endDate || status !== 'ALL') {
        document.getElementById('filteredInfo').style.display = 'inline';
        document.getElementById('totalOriginal').textContent = allRows.length;
      } else {
        document.getElementById('filteredInfo').style.display = 'none';
      }

      currentPage = 1;
      sortData(sortColumn, sortDirection);
      updateTable();
    }

    function applyFilters() {
      applyAllFilters();
      showToast('Filtros aplicados correctamente', 'success');
    }

    function clearFilters() {
      document.getElementById('filterStartDate').value = '';
      document.getElementById('filterEndDate').value = '';
      document.getElementById('filterStatus').value = 'ALL';
      document.getElementById('searchInput').value = '';

      filteredRows = [...allRows];
      document.getElementById('totalBadge').textContent = allRows.length;
      document.getElementById('filteredInfo').style.display = 'none';

      currentPage = 1;
      sortData(sortColumn, sortDirection);
      updateTable();

      showToast('Filtros limpiados', 'success');
    }

    function exportToExcel() {
      const startDate = document.getElementById('filterStartDate').value;
      const endDate = document.getElementById('filterEndDate').value;
      const status = document.getElementById('filterStatus').value;

      let url = '/admin/appointments/export?';
      const params = [];

      if (startDate) params.push(`startDate=${startDate}`);
      if (endDate) params.push(`endDate=${endDate}`);
      if (status && status !== 'ALL') params.push(`status=${status}`);

      url += params.join('&');

      showToast('Descargando Excel...', 'success');
      window.location.href = url;
    }

    function sortData(column, direction) {
      filteredRows.sort((a, b) => {
        let valA = a.dataset[column] || '';
        let valB = b.dataset[column] || '';

        // Convertir a minÃºsculas para comparaciÃ³n case-insensitive
        if (typeof valA === 'string') valA = valA.toLowerCase();
        if (typeof valB === 'string') valB = valB.toLowerCase();

        if (direction === 'asc') {
          return valA > valB ? 1 : valA < valB ? -1 : 0;
        } else {
          return valA < valB ? 1 : valA > valB ? -1 : 0;
        }
      });
    }

    function updateTable() {
      const tbody = document.getElementById('appointments-body');
      const totalRecords = filteredRows.length;
      const totalPages = Math.ceil(totalRecords / pageSize);

      // Ajustar pÃ¡gina actual si es necesario
      if (currentPage > totalPages && totalPages > 0) {
        currentPage = totalPages;
      }
      if (currentPage < 1) currentPage = 1;

      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;

      // Limpiar tabla
      tbody.innerHTML = '';

      // Agregar filas de la pÃ¡gina actual
      const pageRows = filteredRows.slice(start, end);

      if (pageRows.length === 0 && totalRecords === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No se encontraron resultados</td></tr>';
      } else {
        pageRows.forEach(row => tbody.appendChild(row.cloneNode(true)));
      }

      // Actualizar info de paginaciÃ³n
      document.getElementById('showingFrom').textContent = totalRecords > 0 ? start + 1 : 0;
      document.getElementById('showingTo').textContent = Math.min(end, totalRecords);
      document.getElementById('totalRecords').textContent = totalRecords;

      // Generar botones de paginaciÃ³n
      generatePagination(totalPages);
    }

    function generatePagination(totalPages) {
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';

      if (totalPages <= 1) return;

      // BotÃ³n anterior
      const prevLi = document.createElement('li');
      prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
      prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">
        <i class="bi bi-chevron-left"></i>
      </a>`;
      pagination.appendChild(prevLi);

      // Botones de pÃ¡ginas
      const maxButtons = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
      let endPage = Math.min(totalPages, startPage + maxButtons - 1);

      if (endPage - startPage < maxButtons - 1) {
        startPage = Math.max(1, endPage - maxButtons + 1);
      }

      // Primera pÃ¡gina si no estÃ¡ visible
      if (startPage > 1) {
        const li = document.createElement('li');
        li.className = 'page-item';
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(1); return false;">1</a>`;
        pagination.appendChild(li);

        if (startPage > 2) {
          const dots = document.createElement('li');
          dots.className = 'page-item disabled';
          dots.innerHTML = `<span class="page-link">...</span>`;
          pagination.appendChild(dots);
        }
      }

      for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>`;
        pagination.appendChild(li);
      }

      // Ãšltima pÃ¡gina si no estÃ¡ visible
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          const dots = document.createElement('li');
          dots.className = 'page-item disabled';
          dots.innerHTML = `<span class="page-link">...</span>`;
          pagination.appendChild(dots);
        }

        const li = document.createElement('li');
        li.className = 'page-item';
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${totalPages}); return false;">${totalPages}</a>`;
        pagination.appendChild(li);
      }

      // BotÃ³n siguiente
      const nextLi = document.createElement('li');
      nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
      nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">
        <i class="bi bi-chevron-right"></i>
      </a>`;
      pagination.appendChild(nextLi);
    }

    function changePage(page) {
      const totalPages = Math.ceil(filteredRows.length / pageSize);
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      updateTable();

      // Scroll suave a la tabla
      const table = document.getElementById('appointmentsTable');
      if (table) {
        table.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    function initCalendar() {
      var calendarEl = document.getElementById('calendar');
      var rawAppointments = [[${calendarEvents}]];

      console.log('Total appointments para calendario:', rawAppointments.length);
      console.log('Primer appointment RAW:', rawAppointments[0]);

      var events = rawAppointments.map(a => {
        const status = a.status;
        let color = '#6c757d';
        let displayName = 'Sin estado';

        if (status) {
          displayName = status.es || 'Sin estado';

          switch (status.badgeClass) {
            case 'bg-success':  color = '#28a745'; break;
            case 'bg-warning':  color = '#ffc107'; break;
            case 'bg-danger':   color = '#dc3545'; break;
            case 'bg-dark':     color = '#343a40'; break;
            case 'bg-secondary':color = '#6c757d'; break;
            default:            color = '#6c757d';
          }
        }

        // Las fechas y horas ya vienen como strings desde el controlador
        const startDateTime = `${a.date}T${a.time}`;

        const event = {
          title: a.clientName + (a.notes ? " - " + a.notes.substring(0, 20) + (a.notes.length > 20 ? '...' : '') : ""),
          start: startDateTime,
          allDay: false,
          backgroundColor: color,
          borderColor: color,
          textColor: status && status.badgeClass === 'bg-warning' ? '#000' : '#fff',
          display: 'block',
          extendedProps: {
            phone: a.clientPhone,
            status: displayName,
            notes: a.notes || 'Sin notas'
          }
        };

        console.log('Evento generado:', {
          title: event.title,
          start: event.start,
          color: color
        });

        return event;
      });

      console.log('Total eventos generados:', events.length);
      console.log('Ejemplo de evento completo:', events[0]);

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        buttonText: { today: 'Hoy', month: 'Mes', week: 'Semana', day: 'DÃ­a' },
        locale: 'es',
        events: events,
        height: 'auto',
        eventTimeFormat: {
          hour: '2-digit',
          minute: '2-digit',
          hour12: false
        },
        eventDisplay: 'block',
        displayEventTime: true,
        displayEventEnd: false,
        eventClick: function(info) {
          // Buscar la fila correspondiente en la tabla
          const rows = document.querySelectorAll('#appointments-body tr');
          const eventDate = info.event.start.toISOString().split('T')[0];
          const eventTime = info.event.start.toTimeString().substring(0, 5);

          for (let row of rows) {
            if (row.dataset.date === eventDate && row.dataset.time === eventTime) {
              openAppointmentModal(row);
              return;
            }
          }

          // Fallback: mostrar alerta simple si no se encuentra
          const details = `${info.event.title}\n\n` +
                         `ðŸ“ž TelÃ©fono: ${info.event.extendedProps.phone}\n` +
                         `ðŸ“Œ Estado: ${info.event.extendedProps.status}\n` +
                         `ðŸ“ Notas: ${info.event.extendedProps.notes}`;
          alert(details);
        },
        eventDidMount: function(info) {
          console.log('Evento montado en el DOM:', info.event.title, info.event.start);
          info.el.title = `${info.event.title}\nHora: ${info.event.start.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})}`;
        }
      });

      console.log('Renderizando calendario...');
      calendar.render();
      console.log('Calendario renderizado. Total eventos en el calendario:', calendar.getEvents().length);
    }

    function copyLink() {
      const link = document.getElementById('publicLink');
      link.select();
      link.setSelectionRange(0, 99999); // Para mÃ³viles

      navigator.clipboard.writeText(link.value).then(() => {
        const btn = event.target.closest('button');
        const original = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check-lg me-2"></i>Â¡Copiado!';
        btn.classList.replace('btn-light', 'btn-success');

        setTimeout(() => {
          btn.innerHTML = original;
          btn.classList.replace('btn-success', 'btn-light');
        }, 2000);
      });
    }

    // Abrir modal con los datos del appointment
    function openAppointmentModal(row) {
      const id = row.dataset.id;
      const date = row.dataset.date;
      const time = row.dataset.time;
      const client = row.dataset.client;
      const phone = row.dataset.phone;
      const email = row.dataset.email || '';
      const notes = row.dataset.notes || 'Sin notas';
      const status = row.dataset.status;

      console.log('Datos del appointment:', { id, date, time, client, phone, email, notes, status });

      // Rellenar el modal
      document.getElementById('appointmentId').value = id;
      document.getElementById('clientName').value = client;
      document.getElementById('clientPhone').value = phone;
      document.getElementById('clientEmail').value = email;
      document.getElementById('appointmentDate').value = date;
      document.getElementById('appointmentTime').value = time;
      document.getElementById('appointmentNotes').value = notes;

      // Configurar el estado actual
      const statusSelect = document.getElementById('appointmentStatus');
      if (status && status !== 'null' && status !== 'undefined') {
        // Convertir a mayÃºsculas por si acaso
        const statusValue = status.toUpperCase();
        statusSelect.value = statusValue;
        console.log('Estado configurado:', statusValue);
      } else {
        statusSelect.value = 'PENDING';
        console.log('Estado por defecto: PENDING');
      }

      // Configurar link de WhatsApp
      const whatsappLink = document.getElementById('whatsappLink');
      const cleanPhone = phone.replace(/\D/g, ''); // Quitar todo excepto nÃºmeros
      whatsappLink.href = `https://wa.me/${cleanPhone}`;

      // Abrir el modal
      const modal = new bootstrap.Modal(document.getElementById('appointmentModal'));
      modal.show();
    }

    // Guardar cambios de estado
    async function saveAppointmentStatus() {
      const id = document.getElementById('appointmentId').value;
      const newStatus = document.getElementById('appointmentStatus').value;

      try {
        const response = await fetch(`/admin/appointments/${id}/status`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ status: newStatus })
        });

        if (response.ok) {
          // Cerrar modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('appointmentModal'));
          modal.hide();

          // Mostrar mensaje de Ã©xito
          showToast('Estado actualizado correctamente', 'success');

          // Recargar la pÃ¡gina despuÃ©s de 1 segundo
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } else {
          showToast('Error al actualizar el estado', 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        showToast('Error al actualizar el estado', 'error');
      }
    }

    // FunciÃ³n auxiliar para mostrar toasts
    function showToast(message, type) {
      const bgColor = type === 'success' ? '#28a745' : '#dc3545';
      const icon = type === 'success' ? 'check-circle-fill' : 'x-circle-fill';

      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${bgColor};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 9999;
        animation: slideIn 0.3s ease-out;
      `;
      toast.innerHTML = `<i class="bi bi-${icon} me-2"></i>${message}`;

      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Animaciones CSS
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(400px); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>