<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
  <th:block th:replace="~{fragments/head :: favicons}" />
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Restablecer Contraseña – TurnoFácil</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/turnofacil-theme.css}">
  <link rel="stylesheet" th:href="@{/css/auth-pages.css}">
</head>
<body class="auth-page">

<div class="background-decoration">
  <div class="decoration-circle decoration-circle-1"></div>
  <div class="decoration-circle decoration-circle-2"></div>
</div>

<div class="auth-wrapper">
  <div class="auth-card" style="max-width: 500px; margin: 0 auto;">
    <div class="auth-card-container">

      <div class="auth-header">
        <div class="logo-container">
          <i class="bi bi-shield-lock"></i>
        </div>
        <h1>Nueva Contraseña</h1>
        <p th:if="${userName}">Hola, <strong th:text="${userName}">Usuario</strong></p>
        <p th:unless="${userName}">Ingresa tu nueva contraseña</p>
      </div>

      <div class="auth-body">

        <div th:if="${error}" class="auth-alert auth-alert-danger">
          <i class="bi bi-exclamation-triangle-fill"></i>
          <span th:text="${error}">Error</span>
        </div>

        <!-- Si hay error de token expirado y no hay token válido, mostrar enlace para solicitar nuevo -->
        <div th:if="${error != null && token == null}" style="text-align: center; margin-top: 20px;">
          <a href="/auth/forgot-password" class="auth-btn" style="display: inline-block; text-decoration: none;">
            <i class="bi bi-arrow-clockwise me-2"></i>
            Solicitar nuevo enlace
          </a>
          <div class="auth-footer" style="margin-top: 20px;">
            <p>
              <a href="/auth/login">
                <i class="bi bi-arrow-left me-1"></i>
                Volver al inicio de sesión
              </a>
            </p>
          </div>
        </div>

        <!-- Formulario de reset (solo si hay token válido) -->
        <form th:if="${token != null}" th:action="@{/auth/reset-password}" method="post" id="resetForm">
          <input type="hidden" name="token" th:value="${token}">

          <div class="auth-form-group">
            <label for="password" class="auth-form-label">Nueva Contraseña</label>
            <div class="password-input-wrapper">
              <input
                      type="password"
                      id="password"
                      name="password"
                      class="auth-form-control"
                      placeholder="Crea una contraseña segura"
                      required
                      minlength="8"
                      autofocus
              >
              <button type="button" class="password-toggle" onclick="togglePassword('password', this)" aria-label="Mostrar contraseña">
                <i class="bi bi-eye"></i>
              </button>
            </div>
            <div class="password-requirements">
              <small class="auth-form-text d-block mb-2">La contraseña debe cumplir:</small>
              <ul class="password-checklist">
                <li id="req-length"><i class="bi bi-circle"></i> Minimo 8 caracteres</li>
                <li id="req-upper"><i class="bi bi-circle"></i> Al menos una mayuscula</li>
                <li id="req-number"><i class="bi bi-circle"></i> Al menos un numero</li>
                <li id="req-special"><i class="bi bi-circle"></i> Al menos un caracter especial (!@#$%...)</li>
              </ul>
            </div>
          </div>

          <div class="auth-form-group">
            <label for="confirmPassword" class="auth-form-label">Confirmar Contraseña</label>
            <div class="password-input-wrapper">
              <input
                      type="password"
                      id="confirmPassword"
                      name="confirmPassword"
                      class="auth-form-control"
                      placeholder="Repite tu contraseña"
                      required
                      minlength="8"
              >
              <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword', this)" aria-label="Mostrar contraseña">
                <i class="bi bi-eye"></i>
              </button>
            </div>
            <div id="passwordMatchMsg" class="password-match-msg" style="display: none;"></div>
          </div>

          <button type="submit" class="auth-btn">
            <i class="bi bi-check-circle me-2"></i>
            Restablecer Contraseña
          </button>
        </form>

      </div>
    </div>
  </div>
</div>

<script>
  function togglePassword(inputId, btn) {
    var input = document.getElementById(inputId);
    var icon = btn.querySelector('i');
    if (input.type === 'password') {
      input.type = 'text';
      icon.className = 'bi bi-eye-slash';
    } else {
      input.type = 'password';
      icon.className = 'bi bi-eye';
    }
  }

  var form = document.getElementById('resetForm');
  if (form) {
    var password = document.getElementById('password');
    var confirmPassword = document.getElementById('confirmPassword');
    var matchMsg = document.getElementById('passwordMatchMsg');

    function validatePasswordRequirements(pwd) {
      return pwd.length >= 8 && /[A-Z]/.test(pwd) && /[0-9]/.test(pwd) && /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(pwd);
    }

    function updateRequirement(id, isValid) {
      var el = document.getElementById(id);
      var icon = el.querySelector('i');
      if (isValid) {
        el.classList.add('valid');
        el.classList.remove('invalid');
        icon.className = 'bi bi-check-circle-fill';
      } else {
        el.classList.remove('valid');
        el.classList.add('invalid');
        icon.className = 'bi bi-circle';
      }
    }

    function checkPassword() {
      var pwd = password.value;
      updateRequirement('req-length', pwd.length >= 8);
      updateRequirement('req-upper', /[A-Z]/.test(pwd));
      updateRequirement('req-number', /[0-9]/.test(pwd));
      updateRequirement('req-special', /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(pwd));

      if (pwd.length > 0 && !validatePasswordRequirements(pwd)) {
        password.setCustomValidity('La contraseña no cumple los requisitos de seguridad');
      } else {
        password.setCustomValidity('');
      }
    }

    function checkMatch() {
      var pwd = password.value;
      var conf = confirmPassword.value;
      if (conf.length === 0) {
        matchMsg.style.display = 'none';
        return;
      }
      matchMsg.style.display = 'flex';
      if (pwd === conf) {
        matchMsg.className = 'password-match-msg match';
        matchMsg.innerHTML = '<i class="bi bi-check-circle-fill"></i> Las contraseñas coinciden';
      } else {
        matchMsg.className = 'password-match-msg no-match';
        matchMsg.innerHTML = '<i class="bi bi-x-circle-fill"></i> Las contraseñas no coinciden';
      }
    }

    password.addEventListener('input', checkPassword);
    password.addEventListener('input', checkMatch);
    confirmPassword.addEventListener('input', checkMatch);

    form.addEventListener('submit', function(e) {
      if (!validatePasswordRequirements(password.value)) {
        e.preventDefault();
        password.focus();
        return false;
      }
      if (password.value !== confirmPassword.value) {
        e.preventDefault();
        alert('Las contraseñas no coinciden');
      }
    });
  }
</script>

</body>
</html>
