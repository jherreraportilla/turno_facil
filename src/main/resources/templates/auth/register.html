<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
  <th:block th:replace="~{fragments/head :: favicons}" />
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Registro – TurnoFácil</title>

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

  <!-- TurnoFácil Theme (variables y componentes base) -->
  <link rel="stylesheet" th:href="@{/css/turnofacil-theme.css}">

  <!-- Estilos específicos de autenticación -->
  <link rel="stylesheet" th:href="@{/css/auth-pages.css}">
</head>
<body class="auth-page">

<!-- Decoración de fondo -->
<div class="background-decoration">
  <div class="decoration-circle decoration-circle-1"></div>
  <div class="decoration-circle decoration-circle-2"></div>
</div>

<!-- Contenedor principal -->
<div class="auth-wrapper">

  <!-- Hero Section - Solo visible en pantallas grandes -->
  <div class="hero-section">
    <div class="hero-content">
      <h1>
        Comienza a gestionar tus turnos
        <span class="gradient-text">gratis</span>
      </h1>
      <p>
        Crea tu cuenta en segundos y accede a todas las herramientas que necesitas
        para organizar tu negocio de forma profesional.
      </p>

      <ul class="features-list">
        <li>
          <i class="bi bi-check-circle-fill"></i>
          <span>Sin tarjeta de crédito requerida</span>
        </li>
        <li>
          <i class="bi bi-check-circle-fill"></i>
          <span>Configuración en menos de 5 minutos</span>
        </li>
        <li>
          <i class="bi bi-check-circle-fill"></i>
          <span>Soporte incluido desde el primer día</span>
        </li>
        <li>
          <i class="bi bi-check-circle-fill"></i>
          <span>Cancela cuando quieras, sin compromisos</span>
        </li>
      </ul>
    </div>
  </div>

  <!-- Card de Registro -->
  <div class="auth-card" style="max-width: 520px;">
    <div class="auth-card-container">

      <!-- Header -->
      <div class="auth-header">
        <div class="logo-container">
          <i class="bi bi-calendar-check"></i>
        </div>
        <h1>Crear cuenta</h1>
        <p>Comienza a gestionar tus turnos hoy</p>
      </div>

      <!-- Body -->
      <div class="auth-body">

        <!-- Banner de características -->
        <div class="features-banner">
          <h3>
            <i class="bi bi-star-fill"></i>
            Incluye gratis:
          </h3>
          <ul>
            <li>
              <i class="bi bi-check-circle-fill"></i>
              <span>Acceso completo a todas las funcionalidades</span>
            </li>
            <li>
              <i class="bi bi-check-circle-fill"></i>
              <span>Tu página pública de reservas personalizada</span>
            </li>
            <li>
              <i class="bi bi-check-circle-fill"></i>
              <span>Sin tarjeta de crédito requerida</span>
            </li>
          </ul>
        </div>

        <!-- Alerta de error -->
        <div th:if="${error}" class="auth-alert auth-alert-danger">
          <i class="bi bi-exclamation-triangle-fill"></i>
          <span th:text="${error}">Error en el registro</span>
        </div>

        <!-- Formulario -->
        <form th:action="@{/auth/register}" th:object="${user}" method="post" id="registerForm">

          <div class="auth-form-group">
            <label for="name" class="auth-form-label">Nombre del negocio *</label>
            <input
                    type="text"
                    id="name"
                    th:field="*{name}"
                    class="auth-form-control"
                    placeholder="Ej: Peluquería Lucía"
                    required
                    autofocus
            >
          </div>

          <div class="auth-form-group">
            <label for="email" class="auth-form-label">Email *</label>
            <input
                    type="email"
                    id="email"
                    th:field="*{email}"
                    class="auth-form-control"
                    placeholder="tu@negocio.com"
                    required
                    autocomplete="email"
            >
          </div>

          <div class="auth-form-group">
            <label for="phone" class="auth-form-label">Teléfono (WhatsApp)</label>
            <input
                    type="tel"
                    id="phone"
                    th:field="*{phone}"
                    class="auth-form-control"
                    placeholder="+34 600 123 456"
                    autocomplete="tel"
            >
            <small class="auth-form-text">Opcional pero recomendado para recibir notificaciones</small>
          </div>

          <div class="auth-form-group">
            <label for="password" class="auth-form-label">Contraseña *</label>
            <div class="password-input-wrapper">
              <input
                      type="password"
                      id="password"
                      th:field="*{password}"
                      class="auth-form-control"
                      placeholder="Crea una contraseña segura"
                      required
                      minlength="8"
                      autocomplete="off"
                      data-lpignore="true"
                      data-form-type="other"
              >
              <button type="button" class="password-toggle" onclick="togglePassword('password', this)" aria-label="Mostrar contraseña">
                <i class="bi bi-eye"></i>
              </button>
            </div>
            <div class="password-requirements">
              <small class="auth-form-text d-block mb-2">La contraseña debe cumplir:</small>
              <ul class="password-checklist">
                <li id="req-length"><i class="bi bi-circle"></i> Minimo 8 caracteres</li>
                <li id="req-upper"><i class="bi bi-circle"></i> Al menos una mayuscula</li>
                <li id="req-number"><i class="bi bi-circle"></i> Al menos un numero</li>
                <li id="req-special"><i class="bi bi-circle"></i> Al menos un caracter especial (!@#$%...)</li>
                <li id="req-name"><i class="bi bi-circle"></i> No relacionada con el nombre del negocio</li>
              </ul>
            </div>
          </div>

          <button type="submit" class="auth-btn" id="registerButton">
            Crear cuenta gratis
          </button>

        </form>

        <!-- Footer -->
        <div class="auth-footer">
          <p>
            ¿Ya tienes cuenta?
            <a th:href="@{/auth/login}">Inicia sesión</a>
          </p>
        </div>

      </div>
    </div>
  </div>

</div>

<script>
  function togglePassword(inputId, btn) {
    var input = document.getElementById(inputId);
    var icon = btn.querySelector('i');
    if (input.type === 'password') {
      input.type = 'text';
      icon.className = 'bi bi-eye-slash';
    } else {
      input.type = 'password';
      icon.className = 'bi bi-eye';
    }
  }

  // Animación de carga al enviar formulario
  document.getElementById('registerForm').addEventListener('submit', function(e) {
    const password = document.getElementById('password');
    if (!validatePasswordRequirements(password.value)) {
      e.preventDefault();
      password.focus();
      return false;
    }
    const button = document.getElementById('registerButton');
    button.classList.add('loading');
    button.disabled = true;
  });

  // Validación en tiempo real de contraseña
  const password = document.getElementById('password');
  const nameInput = document.getElementById('name');

  function validatePasswordRequirements(pwd) {
    const name = nameInput.value.toLowerCase().replace(/\s+/g, '');
    const nameParts = nameInput.value.toLowerCase().split(/\s+/).filter(p => p.length >= 4);

    const hasLength = pwd.length >= 8;
    const hasUpper = /[A-Z]/.test(pwd);
    const hasNumber = /[0-9]/.test(pwd);
    const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(pwd);

    let hasNoName = true;
    if (name.length >= 3 && pwd.toLowerCase().includes(name)) {
      hasNoName = false;
    }
    for (const part of nameParts) {
      if (pwd.toLowerCase().includes(part)) {
        hasNoName = false;
        break;
      }
    }

    return hasLength && hasUpper && hasNumber && hasSpecial && hasNoName;
  }

  function updateRequirement(id, isValid) {
    const el = document.getElementById(id);
    const icon = el.querySelector('i');
    if (isValid) {
      el.classList.add('valid');
      el.classList.remove('invalid');
      icon.className = 'bi bi-check-circle-fill';
    } else {
      el.classList.remove('valid');
      el.classList.add('invalid');
      icon.className = 'bi bi-circle';
    }
  }

  function checkPassword() {
    const pwd = password.value;
    const name = nameInput.value.toLowerCase().replace(/\s+/g, '');
    const nameParts = nameInput.value.toLowerCase().split(/\s+/).filter(p => p.length >= 4);

    updateRequirement('req-length', pwd.length >= 8);
    updateRequirement('req-upper', /[A-Z]/.test(pwd));
    updateRequirement('req-number', /[0-9]/.test(pwd));
    updateRequirement('req-special', /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(pwd));

    let hasNoName = true;
    if (name.length >= 3 && pwd.toLowerCase().includes(name)) {
      hasNoName = false;
    }
    for (const part of nameParts) {
      if (pwd.toLowerCase().includes(part)) {
        hasNoName = false;
        break;
      }
    }
    updateRequirement('req-name', pwd.length === 0 || hasNoName);

    if (pwd.length > 0 && !validatePasswordRequirements(pwd)) {
      password.setCustomValidity('La contraseña no cumple los requisitos de seguridad');
    } else {
      password.setCustomValidity('');
    }
  }

  password.addEventListener('input', checkPassword);
  nameInput.addEventListener('input', checkPassword);
</script>

</body>
</html>
